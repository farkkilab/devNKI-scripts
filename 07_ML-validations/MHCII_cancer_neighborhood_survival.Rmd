---
title: "R Notebook"
output: html_notebook
---


```{r}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tibble)
library(tidyverse)
library(ComplexHeatmap)
library(survival)
library(survminer)
library(reshape2)
library(ggpubr)
```


#Reading clinical info
```{r}
out.folder.name <- "D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/Neighborhoods/"

cycif2samples <- read.table(file="D:/users/fperez/NKI_TMAs_AF/devNKI-scripts/3_Cell-typeClassification/tCicyf_patients-cores_pass.csv", sep=",", header = TRUE)
clinical.info <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Clinical_data/T-CycIF.updated.csv", sep=",",
                            header = TRUE)

clin.tcycif <- merge(cycif2samples, clinical.info, by.x="patient", by.y="TnumberAVL", all.x = TRUE)

#Selecting columns of interest
clin.tcycif <- clin.tcycif %>% select(any_of(c("patient","cycif.slide", "cycif.core.id","refage",
                                               "figo_stage","growthpattern", "progression",
                                              "daystoprogression","finalstatus","timelastfu",
                                              "resdx","ch_index_cat","metastasis")))


#Structuring data
clin.tcycif$Stage <- NA
clin.tcycif$Stage[clin.tcycif$figo_stage == "FIGO II"] <- 2
clin.tcycif$Stage[clin.tcycif$figo_stage == "FIGO III"] <- 3
clin.tcycif$Stage[clin.tcycif$figo_stage == "FIGO IV"] <- 4

#Structuring Age
clin.tcycif$Age <- NA
clin.tcycif$Age[clin.tcycif$refage < 50] <- 0
clin.tcycif$Age[clin.tcycif$refage >= 50 & clin.tcycif$refage < 60] <- 1
clin.tcycif$Age[clin.tcycif$refage >= 60 & clin.tcycif$refage < 70] <- 2
clin.tcycif$Age[clin.tcycif$refage >= 70 & clin.tcycif$refage < 80] <- 3
clin.tcycif$Age[clin.tcycif$refage >= 80] <- 4

#Following times by month
clin.tcycif$timelastfu <- clin.tcycif$timelastfu / 30.4
clin.tcycif$daystoprogression <- clin.tcycif$daystoprogression / 30.4

#Residual disease
clin.tcycif$resdx[clin.tcycif$resdx == 9] <- NA
clin.tcycif$resdx[clin.tcycif$resdx == 0] <- 3
clin.tcycif$resdx[clin.tcycif$resdx == 2] <- 0
clin.tcycif$resdx[clin.tcycif$resdx == 3] <- 2



#Categorizing metastasis
clin.tcycif$metastasis[clin.tcycif$metastasis == "No metastasis"] <- 0
clin.tcycif$metastasis[clin.tcycif$metastasis == "Metastasis"] <- 1
clin.tcycif$metastasis <- as.numeric(clin.tcycif$metastasis)


#Categorizing charlson index
clin.tcycif$ch_index_cat[clin.tcycif$ch_index_cat == "Charlson 0"] <- 0
clin.tcycif$ch_index_cat[clin.tcycif$ch_index_cat == "Charlson 1-2"] <- 1
clin.tcycif$ch_index_cat[clin.tcycif$ch_index_cat == "Charlson>=3"] <- 2
clin.tcycif$ch_index_cat <- as.numeric(clin.tcycif$ch_index_cat)

#Loading Molecular profiles
M.profiles <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Tables/Molecular_profiles_patients_20231208.csv",
             sep=",", header = TRUE)

M.profiles.clin <- merge(clin.tcycif, M.profiles, by="patient", all.x=TRUE)
M.profiles.clin

M.profiles.clin$therapy_sequence2 <- ifelse(grepl("NACT", M.profiles.clin$therapy_sequence),"IDS","PDS")
M.profiles.clin$therapy_sequence2[is.na(M.profiles.clin$therapy_sequence)] <- NA

M.profiles.clin[M.profiles.clin$Molecular.profile2 == "BRCAmut/met","Molecular.profile2"] <- "BRCAloss"

```



#Reading input information of cell labels
```{r}
cells.labels <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Tables/All_cells_subtype-info_20231129.csv",
                           sep=",", header = TRUE)

```


##Changin the celltypes to scimap format
```{r}
imageid <- paste0(cells.labels$cycif.slide, "_", cells.labels$cycif.core.id)
CellId <- paste0(cells.labels$cycif.slide, "_", cells.labels$cycif.core.id, "_c", cells.labels$CellId)
DNA.cols <- grep("DNA",colnames(cells.labels))
BG.cols <- grep("BG",colnames(cells.labels))

to.scimap <- cells.labels[,-c(DNA.cols[-1],BG.cols)]

to.scimap$imageid <- imageid
to.scimap$CellId <- CellId

to.scimap <- to.scimap %>%  select(imageid, CellId, everything()) %>% select(-cycif.slide, -cycif.core.id)

# write.table(to.scimap,
#             file="D:/users/fperez/NKI_TMAs_AF/Tables/All_cells_subtype_scimap-format_all_channels_20240416.csv",
#             sep=",", row.names = FALSE)
to.scimap
```

#Reading cell neighborhood information
```{r}
neighbors.counts <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Tables/Spatial-cell-counts_radious46px_20231101.csv",
                               sep=",", header = TRUE)
```



```{r}
dat <- sapply(neighbors.counts$CellId, function(x){
  splitted <- strsplit(x, "_")[[1]]
  res <- data.frame(slide= paste(splitted[1:3], collapse = "_"),
              core = splitted[4],
             cellid =as.numeric(gsub("c","",splitted[5])))
  return(res)
})
```


```{r}
t.dat <- as.data.frame(t(dat))
t.dat$slide <- as.character(t.dat$slide)
t.dat$core <- as.character(t.dat$core)
t.dat$cellid <- as.numeric(t.dat$cellid)
neighbors2 <- cbind(neighbors.counts, t.dat)
head(neighbors2)
```
#Generating mask of CD8.T cell probability for Figure1
```{r}
# core10mask <- neighbors2 %>% filter(slide=="TMA_18_810",
#                       core=="core10") %>% 
#                mutate(Core_Names=paste0(core,"_Probabilities_cytomask2")) %>% 
#                select(Core_Names, cellid, CD8.T.cells)
# 
# colnames(core10mask)[2] <- "Cellid"
# colnames(core10mask)[3] <- "proba_0"
# 
# core10mask$proba_0[which(core10mask$proba_0  == 0)]  <- 0.00001
# 
# core10mask$proba_0 <-  core10mask$proba_0 + 1
# 
# core10mask$Cellid <- as.numeric(core10mask$Cellid)
# write.table(core10mask, 
#             file="D:/users/fperez/NKI_TMAs_AF/TMA_18_810/Spatial-cell-counts_radious46px_core10_for_napari.csv",
#             row.names=FALSE, sep=",")
```


```{r}
core58.cancer <- cancers.dat %>% filter(cycif.slide=="TMA_34_504", cycif.core.id=="core29") %>%
                                 mutate(Row.name = paste0(cycif.slide, "_", cycif.core.id, "_c", CellId)) %>%
                                 select(Row.name, ECadherin, CK7, MHCII, MHCII.bin) %>% 
                                 mutate(log2.CK7 = log2(CK7)) %>% 
                                 filter(log2.CK7 > 10.5)
```



```{r}
core58.cancer$MHCII.bin <- ifelse(log2(core58.cancer$MHCII) >= 11.5, "MHCII.high","MHCII.low")


core58mask <- neighbors2 %>% filter(slide=="TMA_34_504", core=="core29") %>%
               mutate(Core_Names=paste0(core,"_Probabilities_cytomask2")) %>%
               mutate(Immune= CD11c.MY + CD15.MY + CD163.MP + CD207.MY + CD31.stromal + CD4.T.cells +  CD68.MP + CD8.T.cells + Other.MY + T.regs + B.cells) %>%
               select(Core_Names, cellid, Immune) %>%
               filter(!is.na(Immune))

core58mask <- merge(core58mask, core58.cancer, by.x="row.names", by.y="Row.name")
core58mask <- core58mask[,-1]

core58mask$MHCII <- log2(core58mask$MHCII)
max.cut <- quantile(core58mask$MHCII, 0.99)
core58mask$MHCII[core58mask$MHCII >= max.cut] = max.cut

#core58mask <- core58mask %>% select(Core_Names, cellid, MHCII)
core58mask <- core58mask %>% select(Core_Names, cellid, MHCII.bin)

colnames(core58mask)[2] <- "Cellid"
#colnames(core58mask)[3] <- "MHCII_mask"
colnames(core58mask)[3] <- "GlobalCellType"

#core58mask$Immune_prox[which(core58mask$Immune_prox  == 0)]  <- 0.00001
#core58mask$Immune_prox <-  core58mask$Immune_prox + 1

core58mask$Cellid <- as.numeric(core58mask$Cellid)
write.table(core58mask,
            file="D:/users/fperez/NKI_TMAs_AF/TMA_34_504/Cancer_MHCIIbin_core29_for_napari.csv",
            row.names=FALSE, sep=",")
```



#Reading the tables with immune cell neighboors of MHCII+ cancer cells
```{r}
file1 <- "D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/Neighborhoods/Cancer_MHCIIpos_immune_neighbours.csv"

file2 <- "D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/Neighborhoods/Cancer_MHCIIneg_immune_neighbours.csv"

MHCIIpos.cancer.neighboors <- read.table(file=file1, sep=",", header=TRUE)
MHCIIneg.cancer.neighboors <- read.table(file=file2, sep=",", header=TRUE)
```


#Merging cell intensity and neighborhood information
```{r}
colnames(neighbors.counts)[1] <- "CellID.long"
cells.data <- cbind(cells.labels, neighbors.counts)

cells.dat <- merge(cells.data, M.profiles.clin, by=c("cycif.slide", "cycif.core.id"))
cells.dat
```

#Calculating MHCII proportion of cells.dat
```{r}
p.mhcii <- cells.dat %>% 
                group_by(patient) %>% 
                    mutate(lower_bound= quantile(log2(MHCII), 0.01),
                           upper_bound= quantile(log2(MHCII), 0.99),
                           MHCII_capped= pmin(pmax(log2(MHCII), lower_bound), upper_bound),
                           # Apply Min-Max scaling
                           MHCII_scaled = (MHCII_capped - lower_bound) / (upper_bound - lower_bound),
                           MHCII.bin=ifelse(MHCII_scaled > 0.5, "MHCII.high","MHCII.low")) %>% 
                    as.data.frame() %>% 
                    pull(MHCII.bin)


p.mhci <- cells.dat %>% 
                group_by(patient) %>% 
                    mutate(lower_bound= quantile(log2(MHCI), 0.01),
                           upper_bound= quantile(log2(MHCI), 0.99),
                           MHCI_capped= pmin(pmax(log2(MHCI), lower_bound), upper_bound),
                           # Apply Min-Max scaling
                           MHCI_scaled = (MHCI_capped - lower_bound) / (upper_bound - lower_bound),
                           MHCI.bin=ifelse(MHCI_scaled > 0.5, "MHCI.high","MHCI.low")) %>% 
                    as.data.frame() %>% 
                    pull(MHCI.bin)

p.STAT1 <- cells.dat %>% 
                group_by(cycif.slide) %>% 
                    mutate(lower_bound= quantile(log2(pSTAT1), 0.01),
                           upper_bound= quantile(log2(pSTAT1), 0.99),
                           pSTAT1_capped= pmin(pmax(log2(pSTAT1), lower_bound), upper_bound),
                           # Apply Min-Max scaling
                           pSTAT1_scaled = (pSTAT1_capped - lower_bound) / (upper_bound - lower_bound),
                           pSTAT1.bin=ifelse(pSTAT1_scaled > 0.5, "pSTAT1.high","pSTAT1.low")) %>% 
                    as.data.frame() %>% 
                    pull(pSTAT1.bin)

cells.dat$MHCII.bin <- p.mhcii
cells.dat$MHCI.bin <- p.mhci
cells.dat$pSTAT1.bin <- p.STAT1
```



```{r}
#Selecting only cancer cells
cancers.dat <- cells.dat[cells.dat$GlobalCellType == "Cancer",]
```


#Defining function to calculate Fold.changes in proportion of neighboors
```{r}
#The input should have a column for each cell.type neighboor of interest
get.fold.changes <- function(input.dat, cells.interest, comparison.name="All.cells", col.strat="MHCII"){
      high.val <- paste0(col.strat,".high")
      low.val <- paste0(col.strat,".low")
      col.interest <- paste0(col.strat, ".bin")
      fold.changes <- sapply(cells.interest, function(x){
        df <- input.dat[!is.na(input.dat[,x]),]
        fold.change <- mean(df %>% filter(!!rlang::sym(col.interest) == high.val) %>% pull(x)) /
                                  mean(df %>% filter(!!rlang::sym(col.interest) == low.val) %>% pull(x))
        #fold.change <- fold.change -1
        
        utest <- wilcox.test(df %>% filter(!!rlang::sym(col.interest) == high.val) %>% pull(x),
                                  df %>% filter(!!rlang::sym(col.interest) == low.val) %>% pull(x))
        pval1 <- utest$p.value
        return(c(fold.change, pval1))
      })
      counts <- table(input.dat[,col.interest])
      fold.changes <- as.data.frame(t(fold.changes))
      fold.changes <- rownames_to_column(fold.changes)
      colnames(fold.changes) <- c("Neighbors","Fold.chage","Pval")
      fold.changes$High.prop = round(counts[1]/(counts[2] + counts[1]),2)
      fold.changes$class = comparison.name
      return(fold.changes)
}
```



#Calculating fold.change of T.cell neighbors between MHCII.high and MHCII.low
```{r}
therapies <- c("PDS","IDS")

neighbors.interest <- c("CD8.T.cells","CD4.T.cells","T.regs", "B.cells" ,"CD11c.MY","CD207.MY",
                        "CD68.MP","CD163.MP","CD15.MY", "CD31.stromal", "Stromal")

#Stratifying by MHCII and Ki67
#The median value + SD of MHCII looks in tCycif images as a good gating point
# cancers.dat <- cancers.dat %>% 
#                     group_by(cycif.slide) %>% 
#                     mutate(MHCII.bin = ifelse(MHCII > (median(MHCII) + sd(MHCII)),"MHCII.high","MHCII.low"),
#                                   Ki67.bin = ifelse(Ki67 > (median(Ki67)+ sd(Ki67)),"Ki67.high","Ki67.low"),
#                                   MHCI.bin = ifelse(MHCI > (median(MHCI) + 0.2 * sd(MHCI)),"MHCI.high","MHCI.low"))

fold.neighbors <- NULL
for (t in therapies){
    sel.dat <- cancers.dat[which(cancers.dat$therapy_sequence2 == t),]
    
    #Calculating fold change in proportion of neighbors
    neighbors.changes <- lapply(unique(sel.dat$Molecular.profile2), function(x){
                    subset <- sel.dat[sel.dat$Molecular.profile2 == x,]
                    get.fold.changes(subset, neighbors.interest, comparison.name=x)
    })
    for (j in 1:length(neighbors.changes)){
      aux <- neighbors.changes[[j]]
      aux$therapy <- t
      fold.neighbors <- rbind(fold.neighbors, aux)
    }
}
fold.neighbors$FDR <- p.adjust(fold.neighbors$Pval)
fold.neighbors$log2FC <- log2(fold.neighbors$Fold.chage)

#Excluding molecular profile others
fold.neighbors <- fold.neighbors %>% filter(class != "Other")
```


```{r}
order.m.profiles=c("BRCAloss","HRD","HRP","CCNE1amp")

fold.neighbors$Neighbors <- factor(fold.neighbors$Neighbors, levels=neighbors.interest)
fold.neighbors$class <- factor(fold.neighbors$class, levels=order.m.profiles) 


for (t in therapies){
  df.set <- fold.neighbors %>% filter(therapy=={t},
                                      FDR < 0.05)
  
  a <- df.set %>% select(class, High.prop) %>%
                  unique() %>% arrange(factor(class, levels = order.m.profiles)) %>% 
                  pull(High.prop)

  ha = HeatmapAnnotation(MHCII = anno_barplot(cbind(a, 1-a), height = unit(1, "cm"),
         gp = gpar(fill = c(8,0), col = c(1,1))))
  
  
  hmap <- Heatmap(matrix(c(1:16), ncol = 4, nrow=4), name = "mat", top_annotation  = ha,
                  cluster_rows = FALSE, cluster_columns = FALSE)
  pdf(paste0(out.folder.name, "/Heatmap_MHCIIpos_prop_",t,".pdf"), width=2.2, height=2.75)
  draw(hmap)
  dev.off()
  
  df.set <- df.set %>%  mutate(FDR.cat = case_when(
                   FDR < 1e-12  ~ 4,
                   FDR < 1e-6  ~ 3,
                   FDR < 1e-3  ~ 2,
                   .default = 1))
  
  p <- ggplot(df.set, aes(x=class, y=Neighbors)) + geom_point(aes(col=log2FC, size=FDR.cat)) + 
          scale_colour_gradient2(low= "blue", mid="grey90", high ="red", midpoint = 0, limits = c(-1,2.3)) +
          #scale_radius(range = c(1,6), limits = c(0.3, 0.8), breaks = c(0.40, 0.50, 0.60, 0.7, 0.8)) +
          scale_radius(range = c(2,6), limits = c(1, 4), breaks = c(1, 2, 3, 4),
                       labels = c("<0.05", "<1^-3", "<1^-6", "<1^-12")) +
          theme_classic() +
          theme(axis.text.x=element_text(size=rel(1.1), angle = 45, vjust = 1.01, hjust=1),
                     axis.text.y=element_text(size=rel(1.1)),
                     axis.title.x=element_blank(), axis.title.y=element_blank(),
                     legend.text=element_text(size=rel(1.1)),
                     legend.title=element_text(size=rel(1.1)),
                     axis.title=element_text(size=rel(1.1)),
                     legend.position = "right") +
          labs(col='log2(FC)', size='FDR')
  print(p)
  ggsave(p, filename=paste0(out.folder.name, "NeighboorsN_MHCIIhighVSlow_FDRdot",t,"_30px.svg"),
          height = 4.7, width = 3.7, units = "in")
}
```

#Repeating analysis for all molecular profiles
```{r}
cancers.fill <- cancers.dat[!is.na(cancers.dat$therapy_sequence),]


mhcii.table <- get.fold.changes(cancers.fill, neighbors.interest, comparison.name="MHCII.diff")
mhci.table <- get.fold.changes(cancers.fill, neighbors.interest, comparison.name="MHCI.diff", col.strat="MHCI")
mhci.table
```


```{r}
fdrs <- p.adjust(c(mhci.table$Pval, mhcii.table$Pval))

df1 <- mhci.table
df1$log2FC <- log2(df1$Fold.chage)
df1$FDR <- fdrs[1:nrow(df1)]
df1 <- df1 %>%  mutate(FDR.cat = case_when(
                 FDR < 1e-12  ~ 4,
                 FDR < 1e-6  ~ 3,
                 FDR < 1e-3  ~ 2,
                 .default = 1))
df1 <- df1[df1$FDR < 0.05,]

df1$Neighbors <- factor(df1$Neighbors, levels=intersect(neighbors.interest, df1$Neighbors))


p <- ggplot(df1, aes(x=class, y=Neighbors)) + geom_point(aes(col=log2FC, size=FDR.cat)) + 
          scale_colour_gradient2(low= "blue", mid="grey90", high ="red", midpoint = 0, limits = c(-1,1.7)) +
          #scale_radius(range = c(1,6), limits = c(0.3, 0.8), breaks = c(0.40, 0.50, 0.60, 0.7, 0.8)) +
          scale_radius(range = c(2,6), limits = c(1, 4), breaks = c(1, 2, 3, 4),
                       labels = c("<0.05", "<1^-3", "<1^-6", "<1^-12")) +
          theme_classic() +
          theme(axis.text.x=element_text(size=rel(1.1), angle = 45, vjust = 1.01, hjust=1),
                     axis.text.y=element_text(size=rel(1.1)),
                     axis.title.x=element_blank(), axis.title.y=element_blank(),
                     legend.text=element_text(size=rel(1.1)),
                     legend.title=element_text(size=rel(1.1)),
                     axis.title=element_text(size=rel(1.1)),
                     legend.position = "right") +
          labs(col='log2(FC)', size='FDR')
print(p)
ggsave(p, filename=paste0(out.folder.name, "Neighboors_MHCIhighVSlow_FDRdot_30px.svg"),
        height = 11, width = 7, units = "cm")



df1 <- mhcii.table
df1$log2FC <- log2(df1$Fold.chage)
start.fdr <- nrow(mhci.table) + 1
df1$FDR <- fdrs[start.fdr:length(fdrs)]
df1 <- df1 %>%  mutate(FDR.cat = case_when(
                 FDR < 1e-12  ~ 4,
                 FDR < 1e-6  ~ 3,
                 FDR < 1e-3  ~ 2,
                 .default = 1))
df1 <- df1[df1$FDR < 0.05,]
df1$Neighbors <- factor(df1$Neighbors, levels=intersect(neighbors.interest, df1$Neighbors))


p <- ggplot(df1, aes(x=class, y=Neighbors)) + geom_point(aes(col=log2FC, size=FDR.cat)) + 
          scale_colour_gradient2(low= "blue", mid="grey90", high ="red", midpoint = 0, limits = c(-1,1.7)) +
          #scale_radius(range = c(1,6), limits = c(0.3, 0.8), breaks = c(0.40, 0.50, 0.60, 0.7, 0.8)) +
          scale_radius(range = c(2,6), limits = c(1, 4), breaks = c(1, 2, 3, 4),
                       labels = c("<0.05", "<1^-3", "<1^-6", "<1^-12")) +
          theme_classic() +
          theme(axis.text.x=element_text(size=rel(1.1), angle = 45, vjust = 1.01, hjust=1),
                     axis.text.y=element_text(size=rel(1.1)),
                     axis.title.x=element_blank(), axis.title.y=element_blank(),
                     legend.text=element_text(size=rel(1.1)),
                     legend.title=element_text(size=rel(1.1)),
                     axis.title=element_text(size=rel(1.1)),
                     legend.position = "right") +
          labs(col='log2(FC)', size='FDR')
print(p)
ggsave(p, filename=paste0(out.folder.name, "Neighboors_MHCIIhighVSlow_FDRdot_30px.svg"),
        height = 11, width = 7, units = "cm")
```

```{r}
can.set <- cancers.dat %>% filter(MHCII.bin == "MHCII.high" | MHCI.bin == "MHCI.high") %>% 
          mutate(MHC.status=paste0(MHCII.bin,"_",MHCI.bin)) %>% 
          select(any_of(c("cycif.slide","cycif.core.id","MHC.status",neighbors.interest))) %>% 
          filter(!MHC.status == "MHCII.high_MHCI.high") 

can.set[is.na(can.set)] <- 0 

melted.set <- melt(can.set)

melted.set %>% group_by(MHC.status, variable) %>% 
               summarise(Mean.abundance = mean(value)) %>% 
               as.data.frame() %>% 
               pivot_wider(names_from = MHC.status, values_from = Mean.abundance) %>% 
               mutate(Difference = MHCII.low_MHCI.high - MHCII.high_MHCI.low)


my_comparisons <- list(c("MHCII.high_MHCI.high", "MHCII.high_MHCI.low"),
                       c("MHCII.high_MHCI.high", "MHCII.low_MHCI.high"),
                       c("MHCII.low_MHCI.high", "MHCII.high_MHCI.low"))

df <- melted.set[melted.set$variable == "CD8.T.cells",]
df$value <- log(df$value + 0.1)

p2 <- ggboxplot(df, x="MHC.status", y="value", add.params=list(fill=NA, width=0.3),
          color="MHC.status") +
         stat_compare_means(comparisons = my_comparisons, label="p.signif") + 
         ylab("Proportion of neighbors") +
         xlab("") +
         facet_wrap(~variable)
print(p2)
```




#Getting patients IDs, of patient's with above 5% of cancer cells
```{r}
#Calculating proportion of cancer cells by core and by patient
n.by.core <- cells.labels %>% group_by(cycif.slide, cycif.core.id, GlobalCellType) %>% summarise(N=n())
n.by.core.clin <- merge(n.by.core, M.profiles.clin, by=c("cycif.slide", "cycif.core.id"))
cancer.prop.patient <- n.by.core.clin %>% group_by(patient) %>%
                        mutate(Prop.cell = N/sum(N)) %>% filter(GlobalCellType == "Cancer") %>%
                        summarise(Cancer.prop=sum(Prop.cell))

high.cancer.prop.patients <- cancer.prop.patient %>% filter(Cancer.prop >= 0.05) %>% pull(patient)


cancer.prop.by.core <- cells.labels %>% group_by(cycif.slide, cycif.core.id, GlobalCellType) %>%
                                        summarise(N=n()) %>%
                                        mutate (Total.cells=sum(N)) %>% 
                                        filter(GlobalCellType == "Cancer") %>% 
                                        select(-GlobalCellType)


cancer.prop.by.core <- cells.labels %>% group_by(cycif.slide, cycif.core.id, GlobalCellType) %>%
                                        summarise(N=n()) %>%
                                        mutate (Total.cells=sum(N)) %>% 
                                        filter(GlobalCellType == "Cancer") %>% 
                                        select(-GlobalCellType)

colnames(cancer.prop.by.core)[3] <- "N.cancer.cells"

write.table(cancer.prop.by.core,
      file="D:/users/fperez/NKI_TMAs_AF/Core_stats_Ncancer_cells.csv", sep=",", row.names=FALSE)
```



#Calculating proportion of MHCII+ cancer cells per patient
```{r}
#Get the proportion of cancer cells per core, with MHCII expression above the med+sd
MHCII.prop.cores <- cancers.dat %>% group_by(cycif.slide, cycif.core.id) %>%  
                    summarise(total=n(),
                              mhcii_high_count = sum(MHCII.bin == "MHCII.high")) %>% 
                    mutate(Prop.pos = mhcii_high_count/ total) %>% 
                    select(-total, -mhcii_high_count)



#Merging with patients Ids and clinical info
MHCII.cores.prop.clin <- merge(MHCII.prop.cores, M.profiles.clin, by=c("cycif.slide", "cycif.core.id"))

#Select only patients with at least 2 cores
MHCII.cores.prop.clin <- MHCII.cores.prop.clin %>% group_by(patient) %>%
                                                    mutate(N.cores=n()) %>% filter(N.cores >= 2)

#Get median proportion by patient's cores
MHCII.prop.patient <- MHCII.cores.prop.clin %>% group_by(patient) %>% summarise(Med.prop = median(Prop.pos))

#Merge with clinical info
M.profiles.clin.patient <- M.profiles.clin %>% select(-cycif.slide, -cycif.core.id, -therapy_sequence) %>% unique()
MHCII.prop.patient.clin <- merge(MHCII.prop.patient, M.profiles.clin.patient)

#Select only patients with at least 5% of cancer cells in all samples 
MHCII.prop.patient.clin <- MHCII.prop.patient.clin[MHCII.prop.patient.clin$patient %in% high.cancer.prop.patients,]


MHCII.cores.prop.clin %>% arrange(desc(Prop.pos))
```




#Calculating proportion of MHCI+ cancer cells per patient
```{r}
#Get the proportion of cancer cells per core, with MHCII expression above the med+sd
MHCI.prop.cores <- cancers.dat %>% group_by(cycif.slide, cycif.core.id) %>%  
                    summarise(total=n(),
                              pSTAT1_high_count = sum(pSTAT1.bin == "pSTAT1.high")) %>% 
                    mutate(Prop.pos = pSTAT1_high_count/ total) %>% 
                    select(-total, -pSTAT1_high_count)

#Merging with patients Ids and clinical info
MHCI.cores.prop.clin <- merge(MHCI.prop.cores, M.profiles.clin, by=c("cycif.slide", "cycif.core.id"))

#Select only patients with at least 2 cores
MHCI.cores.prop.clin <- MHCI.cores.prop.clin %>% group_by(patient) %>%
                                                    mutate(N.cores=n()) %>% filter(N.cores >= 2)

#Get median proportion by patient's cores
MHCI.prop.patient <- MHCI.cores.prop.clin %>% group_by(patient) %>% summarise(Med.prop = median(Prop.pos))

#Merge with clinical info
M.profiles.clin.patient <- M.profiles.clin %>% select(-cycif.slide, -cycif.core.id, -therapy_sequence) %>% unique()
MHCI.prop.patient.clin <- merge(MHCI.prop.patient, M.profiles.clin.patient)

#Select only patients with at least 5% of cancer cells in all samples 
MHCI.prop.patient.clin <- MHCI.prop.patient.clin[MHCI.prop.patient.clin$patient %in% high.cancer.prop.patients,]


MHCI.cores.prop.clin %>% filter(cycif.slide=="TMA_43_616") %>% arrange(desc(Prop.pos))
```









```{r}
core.cell.prop <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/01_Survival_Proportions_November_medians/Proportions_by_core.csv", sep=",", header = TRUE)

core.cell.prop$GlobalCellType[core.cell.prop$GlobalCellType == "CD8.effector.T.cells"] <- "CD8.T.cells"
core.cell.prop$GlobalCellType[core.cell.prop$GlobalCellType == "CD8.CD45RO.T.cells"] <- "CD8.T.cells"
core.cell.prop$GlobalCellType[core.cell.prop$GlobalCellType == "CD8.PD1.T.cells"] <- "CD8.T.cells"
core.cell.prop$GlobalCellType[core.cell.prop$GlobalCellType == "CD4.CD45RO.T.cells"] <- "CD4.T.cells"
core.cell.prop$GlobalCellType[core.cell.prop$GlobalCellType == "CD4.PD1.T.cells"] <- "CD4.T.cells"


#The median by patient is taken from the proportions for each core
patient.cell.prop <- core.cell.prop %>% group_by(patient, GlobalCellType) %>% 
                      summarise(Proportion = median(Proportion)) %>% as.data.frame() %>%
                      pivot_wider(names_from = GlobalCellType, values_from = Proportion)
patient.cell.prop[is.na(patient.cell.prop)] <- 0 
patient.cell.prop
```



#Calculating by patient/sample the association of MHCII with Immune cell abundance
```{r}
MHCII.cell.prop <- merge(MHCII.prop.patient.clin, patient.cell.prop, by="patient")
MHCII.cell.prop <- MHCII.cell.prop %>% mutate(MHCII.strat= ntile(MHCII.cell.prop$Med.prop,3)) %>% 
                    mutate(MHCII.stat = case_when(
                      MHCII.strat == 1 ~ "Low",
                      MHCII.strat == 2 ~ "Mid",
                      MHCII.strat == 3 ~ "High",
                    ))

MHCII.cell.prop$MHCII.stat <- factor(MHCII.cell.prop$MHCII.stat, levels=c("Low","Mid","High"))
my_comparisons <- list( c("Low", "Mid"), c("Mid", "High"), c("Low", "High") )

#Plots for the cells with higher abundance
cells.interest <- c("CD11c.MY", "CD163.MP", "CD68.MP")
MHCII.sel.cells <- MHCII.cell.prop %>% select(patient, MHCII.stat, therapy_sequence2, any_of(cells.interest))
df <- melt(MHCII.sel.cells)
colnames(df)[4] <- "Cell.type"

p <- ggboxplot(df, x = "MHCII.stat", y = "value") + facet_wrap(~Cell.type) +
  theme_bw() + xlab("HLA_DPB1 expression") +
  theme(axis.title = element_text(size=rel(1.2)),
        axis.text = element_text(size=rel(1.2)),
        strip.text = element_text(size=rel(1.15))) + 
  stat_compare_means(comparisons = my_comparisons, 
                     symnum.args=list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, Inf), symbols=c("****", "***", "**", "*", "ns"))) +
  ylim(0,0.32) + xlab("Prop. MHCII+ positives CCs") +
  ylab("tCycif cell type propotions")
print(p)

ggsave(p,
       file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/tCycif_proportions/Cell_proportions1_MHCII_cancer.png",
       width = 13, height = 7, units = "cm")
ggsave(p,
       file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/tCycif_proportions/Cell_proportions1_MHCII_cancer.svg",
       width = 13, height = 7, units = "cm")



#Plots for the cells with lowe  abundance
cells.interest <- c("CD8.T.cells", "CD4.T.cells", "T.regs")
MHCII.sel.cells <- MHCII.cell.prop %>% select(patient, MHCII.stat, therapy_sequence2, any_of(cells.interest))
df <- melt(MHCII.sel.cells)
colnames(df)[4] <- "Cell.type"

p <- ggboxplot(df, x = "MHCII.stat", y = "value") + facet_wrap(~Cell.type) +
  theme_bw() + xlab("HLA_DPB1 expression") +
  theme(axis.title = element_text(size=rel(1.2)),
        axis.text = element_text(size=rel(1.2)),
        strip.text = element_text(size=rel(1.15))) + 
  stat_compare_means(comparisons = my_comparisons, 
                     symnum.args=list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, Inf), symbols=c("****", "***", "**", "*", "ns"))) +
  ylim(0,0.1) + xlab("Prop. MHCII+ positives CCs") +
  ylab("tCycif cell type propotions")
print(p)

ggsave(p,
       file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/tCycif_proportions/Cell_proportions2_MHCII_cancer.png",
       width = 13, height = 7, units = "cm")
ggsave(p,
       file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/tCycif_proportions/Cell_proportions2_MHCII_cancer.svg",
       width = 13, height = 7, units = "cm")


#To add p-values to the last plots
p <- ggboxplot(df, x = "MHCII.stat", y = "value") + facet_wrap(~Cell.type) +
  theme_bw() + xlab("HLA_DPB1 expression") +
  theme(axis.title = element_text(size=rel(1.2)),
        axis.text = element_text(size=rel(1.2)),
        strip.text = element_text(size=rel(1.15))) + 
  stat_compare_means(comparisons = my_comparisons, 
                     symnum.args=list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, Inf), symbols=c("****", "***", "**", "*", "ns"))) +
  xlab("Prop. MHCII+ positives CCs") + ylim(0,0.165) +
  ylab("tCycif cell type propotions")
ggsave(p,
       file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/05_ML_validations/tCycif_proportions/Cell_proportions21_MHCII_cancer.svg",
       width = 13, height = 7, units = "cm")
```




###Inspecting the proportion by patient
```{r}
wilcox.test(MHCII.prop.patient.clin[MHCII.prop.patient.clin$growthpattern == "papillar","Med.prop"], 
            MHCII.prop.patient.clin[MHCII.prop.patient.clin$growthpattern == "solid","Med.prop"])


#Boxplot by growthpattern
p<- ggplot(MHCII.prop.patient.clin, aes(x=growthpattern, y=Med.prop)) + geom_violin() +
        geom_boxplot(fill=NA, width=0.2) + theme_bw() +
        ylab("Proportion of MHCII+ cancer cells") + facet_wrap(~therapy_sequence2)
print(p)
ggsave(p, filename=paste0(out.folder.name, "Boxplot_MHCIIprop_growthpattern.png"),
          height = 12, width = 14, units = "cm")
```

#Survival analysis using MHCII+ proportion
```{r}
therapies <- c("PDS","IDS")

formulas.cox <- c('Surv(timelastfu, finalstatus) ~ MHCII.strat + Age + Stage + Molecular.profile + Therapy.sequence',
            'Surv(daystoprogression, progression)~ MHCII.strat + Age + Stage + Molecular.profile + Therapy.sequence')

formulas.names <- c("OS","PFI")
formulas.labs <- c("OS probability","PFI probability")

MHCII.prop.patient.clin$Therapy.sequence <- MHCII.prop.patient.clin$therapy_sequence2
MHCII.prop.patient.clin$Molecular.profile <- MHCII.prop.patient.clin$Molecular.profile2

for (i in 1:length(formulas.cox)){
    df <- MHCII.prop.patient.clin 
    #Stratification in ntiles for cox models
    df$MHCII.strat <- ntile(df$Med.prop,3)
    
    #Cox model 
    cox.model <- coxph(as.formula(formulas.cox[i]), data=df)
    p1 <- ggforest(cox.model, data = df, main=paste0(formulas.labs[i]," ALL"))
    print(p1)
    ggsave(p1, file=paste0(out.folder.name, "Cox_MHCII_ALL_", formulas.names[i],".svg"),
         width = 14, height = 11, units = "cm")
    ggsave(p1, file=paste0(out.folder.name, "Cox_MHCII_ALL_", formulas.names[i],".png"),
     width = 14, height = 11, units = "cm")
}

##Selecting others and creating a model for PDS and a model for IDS
#Stratification of samples individually for PDS and IDS

formulas.cox <- c('Surv(timelastfu, finalstatus) ~  MHCII.strat + Age + Stage + Molecular.profile',
              'Surv(daystoprogression, progression)~ MHCII.strat +  Stage + Molecular.profile')

formulas.kapplan <- c('Surv(timelastfu, finalstatus) ~  MHCII.bin',
              'Surv(daystoprogression, progression)~ MHCII.bin')

formulas.names <- c("OS","PFI")
formulas.labs <- c("OS probability","PFI probability")

for (t in therapies){
  df <- MHCII.prop.patient.clin
  
  #Stratification in ntiles for cox models
  df$MHCII.strat <- ntile(df$Med.prop,3)
  
  df <- df %>% filter(therapy_sequence2 == {t})
  
  #Stratification in two groups for KM
  df$MHCII.bin <- ifelse(df$Med.prop > median(df$Med.prop),1,0)

  
  for (i in 1:length(formulas.kapplan)){
     #Cox model 
     cox.model <- coxph(as.formula(formulas.cox[i]), data=df)
     p1 <- ggforest(cox.model, data = df, main=paste0(formulas.labs[i]," ", t))
     print(p1)
     ggsave(p1, file=paste0(out.folder.name, "Cox_MHCII_",t, "_", formulas.names[i],".png"),
           width = 14, height = 7, units = "cm")
     ggsave(p1, file=paste0(out.folder.name, "Cox_MHCII_",t, "_", formulas.names[i],".svg"),
           width = 14, height = 7, units = "cm")
     
     #Kapplan-Meir
     fit <- survfit(as.formula(formulas.kapplan[i]), data = df)
     logrank = surv_pvalue(fit, df)
     pval=logrank$pval.txt
     
     p <- ggsurvplot(fit, data = df, risk.table = TRUE, p.val=TRUE,
                        conf.int = TRUE, palette = c("#4d4dff", "#ff5a36"),
                       legend.labs=c("MHCII.low.prop", "MHCII.high.prop"), tables.y.text = FALSE, legend.title="",
                       break.time.by=30, ylab=formulas.labs[i])
     p$plot <- p$plot + theme(legend.key.width = unit(3, "line"),
                                 plot.margin = margin(t = 0,  r = 2, b = 0, l = 2, unit = "cm"),
                                 legend.key.height = unit(1.5, "line"))
     p$plot <- p$plot + ggplot2::annotate("text", x = 75, y = 0.85, label =pval, size = 5)
     p$table <- p$table + theme(plot.margin = margin(t = 0,  r = 2, b = 5, l = 2, unit = "cm"))
     plot.to.save <- list(p$plot, p$table)
     ggsave(file=paste0(out.folder.name,"Kapplan_MHCII_",t, "_", formulas.names[i],".png"),
           arrangeGrob(grobs = plot.to.save, ncol = 1),
         width = 13, height = 19, units = "cm")
  }
}

##Selecting others and stratification by therapy, creating a model for PDS and a model for IDS
formulas.cox <- c('Surv(timelastfu, finalstatus) ~ MHCII.strat + Age + Stage + therapy_sequence2',
            'Surv(daystoprogression, progression)~ MHCII.strat + Age + Stage + therapy_sequence2')

df <- MHCII.prop.patient.clin %>% filter(Molecular.profile2=="CCNE1amp" |
                                         Molecular.profile2=="HRP")
df$MHCII.strat <- ntile(df$Med.prop,3)

for (i in 1:length(formulas.cox)){
  #Cox model 
  cox.model <- coxph(as.formula(formulas.cox[i]), data=df)
  p1 <- ggforest(cox.model, data = df, main=paste0(formulas.labs[i]," HRPs"))
  print(p1)
  ggsave(p1, file=paste0(out.folder.name, "Cox_MHCII_HRPs_", formulas.names[i],".png"),
       width = 14, height = 11, units = "cm")
}
```


###Categorizing MHCII and merging with RNAexpression
```{r}
nanostring <- read.table(file="D:/users/fperez/NKI_TMAs_AF/RNA_nanostring_OTTA/mSafe_Fernando Perez_Lilian van Wagensveld/OTTA_NanoII_expression.csv",
                                    sep=",",header=TRUE)

link.table <- read.table(file="D:/users/fperez/NKI_TMAs_AF/RNA_nanostring_OTTA/mSafe_Fernando Perez_Lilian van Wagensveld/CFMPB297_RNA_OTTA_consortium.csv",
                         sep=",",header=TRUE)

nanostring.link <- merge(nanostring, link.table, by.x="study_ID",by.y="CFsample")


Pat.MHCII.cat3 <- MHCII.prop.patient.clin %>%
                      mutate(MHCII.cat = ntile(Med.prop, 3)) %>%
                      select(patient, Med.prop, MHCII.cat, Molecular.profile2, therapy_sequence2)

Pat.MHCII.cat2 <- MHCII.prop.patient.clin %>%
                      mutate(MHCII.cat = ntile(Med.prop, 2)) %>%
                      select(patient, Med.prop, MHCII.cat, Molecular.profile2, therapy_sequence2)


colnames(Pat.MHCII.cat3) <- c("patient","MHCII.prop","MHCII.cat", "Molecular.profile", "Therapy.sequence")
colnames(Pat.MHCII.cat2) <- c("patient","MHCII.prop","MHCII.cat", "Molecular.profile", "Therapy.sequence")


RNA.MHCII.cat <- merge(Pat.MHCII.cat3, nanostring.link, by.x="patient", by.y="TissueNumber", all.x=TRUE, all.y=TRUE)


HRPs.RNA.MHCII.cat <- RNA.MHCII.cat %>% filter(Molecular.profile == "HRP" | Molecular.profile == "CCNE1amp") %>%
                        mutate(MHCII.cat = ntile(MHCII.prop, 3)) %>% 
                        group_by(Therapy.sequence) %>% 
                        mutate(MHCII.therapy.cat = ntile(MHCII.prop, 3))

 write.table(RNA.MHCII.cat,
             file="D:/users/fperez/NKI_TMAs_AF/RNA_nanostring_OTTA/mSafe_Fernando Perez_Lilian van Wagensveld/RNA_Nanostring_MHCIIcat_NKI.csv", sep=",", row.names = FALSE)
 
 write.table(HRPs.RNA.MHCII.cat,
             file="D:/users/fperez/NKI_TMAs_AF/RNA_nanostring_OTTA/mSafe_Fernando Perez_Lilian van Wagensveld/RNA_Nanostring_MHCIIcat_NKI_HRPs.csv", sep=",", row.names = FALSE)
```


###Analyzing the neighbors of MHCII cancer cells
```{r}
#Selecting only rows of neighbors of MHCIIpos cancer cells
#Selecting the rows corresponding to immune celltypes
MHCIIpos.cancer.neighbors.dat <- to.scimap %>% filter(CellId %in% MHCIIpos.cancer.neighboors$Neighbour_CellId) %>%
                                  filter(GlobalCellType != "Other", 
                                         GlobalCellType != "Others",
                                         GlobalCellType != "Other.immune",
                                         GlobalCellType != "CD31.stromal")  %>% 
                                  mutate(Cancer.neighbor="MHCII.pos")

#Selecting only rows of neighbors of MHCIIneg cancer cells
#Selecting the rows corresponding to immune celltypes
MHCIIneg.cancer.neighbors.dat <- to.scimap %>% filter(CellId %in% MHCIIneg.cancer.neighboors$Neighbour_CellId) %>%
                                  filter(GlobalCellType != "Other", 
                                          GlobalCellType != "Others",
                                          GlobalCellType != "Other.immune",
                                          GlobalCellType != "CD31.stromal")  %>% 
                                  mutate(Cancer.neighbor="MHCII.neg")


Cancer.neighbors <- rbind(MHCIIpos.cancer.neighbors.dat, MHCIIneg.cancer.neighbors.dat)
Cancer.neighbors$Cancer.neighbor <- factor(Cancer.neighbors$Cancer.neighbor, levels=c("MHCII.pos","MHCII.neg"))

Cancer.neighbors$cycif.slide <- sapply(Cancer.neighbors$imageid, function(x){
                                       paste(strsplit(x, "_")[[1]][1:3], collapse = "_")})

Cancer.neighbors$cycif.core.id <- sapply(Cancer.neighbors$imageid, function(x){strsplit(x, "_")[[1]][4]})

```

#Merging the information of neighboors with clinical and molecular profile info
```{r}
Cancer.neighbors.clin <- merge(Cancer.neighbors, M.profiles.clin, by=c("cycif.slide", "cycif.core.id"))
```



#Defining function to calculate Fold.changes in proportion of neighboors
```{r}
##The input should have a column for each cell.type neighboor of interest
get.fold.changes <- function(input.dat, cell.interest, markers.interest = "Ki67", comparison.name="All.cells"){
      fold.changes <- sapply(cell.interest, function(x){
        df <- input.dat %>% filter(GlobalCellType == {x})

        mean.by.type <- df %>% group_by(Cancer.neighbor) %>%
                          summarise_at(markers.interest, mean, na.rm = TRUE)
        fold.change <- as.numeric(mean.by.type[1,2] / mean.by.type[2,2])
        
        if(sum(df$Cancer.neighbor=="MHCII.pos") > 0 & sum(df$Cancer.neighbor=="MHCII.neg") > 0){
           utest <- wilcox.test(df[which(df$Cancer.neighbor=="MHCII.pos"),markers.interest],
                                    df[which(df$Cancer.neighbor=="MHCII.neg"),markers.interest])
           pval1 <- utest$p.value
        }else{
          pval1 <- 1
        }
        return(c(fold.change, pval1))
      })
      fold.changes <- as.data.frame(t(fold.changes))
      fold.changes <- rownames_to_column(fold.changes)
      colnames(fold.changes) <- c("Neighbors","Fold.chage","Pval")
      fold.changes$class = comparison.name
      return(fold.changes)
}

#Function for min.max normalization
normalize <- function(x, na.rm = TRUE) {
    return((x- min(x)) /(max(x)-min(x)))
}

#Function to set value of 99.9 percentile to outliers
outlier.trim <- function(signal.data, max.quantile=0.999, min.quantile=0.001){
  for (i in (1:ncol(signal.data))){
    #Check if there are outliers
      max.value <- quantile(signal.data[,i], max.quantile)
      min.value <- quantile(signal.data[,i], min.quantile)
      to.adjust.pos <- which(signal.data[,i] >= max.value)
      signal.data[to.adjust.pos,i] <- max.value
      to.adjust.pos <- which(signal.data[,i] <= min.value)
      signal.data[to.adjust.pos,i] <- min.value
  }
  return(signal.data)
}
```


#Calculating the fold.change of marker expression between neighboors of MHCIIpos/MHCIIneg cancer cells
```{r}

cells.interest <- c("CD8.T.cells", "CD4.T.cells", "T.regs", "B.cells", "CD11c.MY",
                   "CD207.MY", "CD163.MP", "CD68.MP", "CD15.MY", "Other.MY")

selected.markers <- c("Ki67", "pSTAT1", "pTBK1",  "TIM3", "PD1",  "MHCII","GranzymeB")

for (marker in selected.markers){
  fold.neighbors <- NULL
  for (t in therapies){
      sel.dat <- Cancer.neighbors.clin %>% filter(therapy_sequence2 == {t},
                                                  Molecular.profile2 != "Other")
      
      #Log2 of markers, outliear value trimming and scaling by slide
      cols <- which(colnames(sel.dat) =='DNA1'):c(which(colnames(sel.dat) =='Area') - 1)
      sel.dat[,cols] <- log2(sel.dat[,cols])
      for (slide in unique(sel.dat$cycif.slide)){
         slide.rows <- which(sel.dat$cycif.slide %in% slide)
         sel.dat[slide.rows,cols] <- outlier.trim(sel.dat[slide.rows,cols], max.quantile=0.99, min.quantile=0.01)
      }
      sel.dat <- sel.dat %>%
                group_by(cycif.slide) %>%
                mutate(across(where(is.numeric), ~ as.numeric(normalize(.)))) %>%
                as.data.frame()
      
      #Calculating fold change in marker expression of neighbors MHCIIpos/MHCIIneg cancer cells
      neighbors.changes <- lapply(unique(sel.dat$Molecular.profile2), function(x){
                       subset <- sel.dat[which(sel.dat$Molecular.profile2 == x),]
                       get.fold.changes(subset, cells.interest, markers.interest = marker, comparison.name=x)
      })
      for (j in 1:length(neighbors.changes)){
        aux <- neighbors.changes[[j]]
        aux$therapy <- t
        fold.neighbors <- rbind(fold.neighbors, aux)
      }
  }
  fold.neighbors$FDR <- p.adjust(fold.neighbors$Pval)
  fold.neighbors$log2FC <- log2(fold.neighbors$Fold.chage)
  fold.neighbors
  
  
  
  order.m.profiles=c("BRCAloss","HRD","HRP","CCNE1amp")
  fold.neighbors$Neighbors <- factor(fold.neighbors$Neighbors, levels=cells.interest)
  fold.neighbors$class <- factor(fold.neighbors$class, levels=order.m.profiles)

  for (t in therapies){
    df.set <- fold.neighbors %>% filter(therapy=={t})
    
    df.set <- df.set %>%  mutate(FDR.cat = case_when(
                     FDR < 1e-12  ~ 4,
                     FDR < 1e-6  ~ 3,
                     FDR < 1e-3  ~ 2,
                     FDR < 0.05  ~ 1,
                     .default = NA))
    df.set$log2FC[which(is.na(df.set$FDR.cat))] <- NA
    
    p <- ggplot(df.set, aes(x=class, y=Neighbors)) + geom_point(aes(col=log2FC, size=FDR.cat)) + 
            scale_colour_gradient2(low= "blue", mid="grey90", high ="gold", midpoint = 0, limits=c(-1,1.2)) +
            scale_radius(range = c(2,6), limits = c(1, 4), breaks = c(1, 2, 3, 4),
                         labels = c("<0.05", "<1^-3", "<1^-6", "<1^-12")) +
            theme_classic() + ylab("Cancer's cell neighbors") +
            theme(axis.text.x=element_text(size=rel(1.1), angle = 45, vjust = 1.01, hjust=1),
                       axis.text.y=element_text(size=rel(1.1)),
                       axis.title.x=element_blank(),
                       legend.text=element_text(size=rel(1.1)),
                       legend.title=element_text(size=rel(1.1)),
                       axis.title=element_text(size=rel(1.1)),
                       legend.position = "right") +
            labs(col='log2(FC)', size='FDR', title =paste0(t," ", marker))
    print(p)
     ggsave(p, filename=paste0(out.folder.name, paste0("Expression_", marker, "_MHCIIhighVSlow_FDRdot_",t,".svg")),
             height = 4.7, width = 3.7, units = "in")
  }
}
```


#Making violin plots to compare the expression of relevant markers in neighboors of MHCII+ cancer cells
```{r}
cols <- c("pSTAT1")
cell.types <- c("CD11c.MY","CD8.T.cells","T.regs", "CD4.T.cells")

df <- Cancer.neighbors.clin #%>% filter(therapy_sequence2 == {t})

df[,cols] <- log2(df[,cols])

for (slide in unique(df$cycif.slide)){
    slide.df <- df %>% filter(cycif.slide == slide) %>%
                  select(all_of(cols))
    slide.rows <- which(df$cycif.slide %in% slide)
    df[slide.rows,cols] <- outlier.trim(slide.df, max.quantile=0.99, min.quantile=0.01)
    rm(slide.df)
}

df <- df %>% filter(GlobalCellType %in% cell.types) %>%
            select(all_of(c("CellId","cycif.slide","GlobalCellType",
                             "therapy_sequence2","Cancer.neighbor", cols))) %>%
               group_by(cycif.slide) %>%
               mutate(across(where(is.numeric), ~ as.numeric(scale(.)))) %>%
               as.data.frame()

melted.df <- melt(df)

melted.df$GlobalCellType <- factor(melted.df$GlobalCellType, levels=cell.types)

my_comparisons <-  list(c("MHCII.pos", "MHCII.neg"))
p <- ggviolin(melted.df, x="Cancer.neighbor", y="value", fill="Cancer.neighbor",
              palette = c("#FC4E07", "#00AFBB")) +
              geom_boxplot(outlier.shape = NA, width=0.3) + ylim(-2.5,5) +
              stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = 4.5) +
              theme_bw() + geom_hline(yintercept=0, lty=3, col="grey") +
              theme(axis.text.x = element_blank()) +
              facet_wrap(~GlobalCellType, nrow =1)
      
           
print(p)
ggsave(p, filename=paste0(out.folder.name,"/Violin_plots_pSTAT1_MHCII_neighboors.svg"), width = 13,
       height = 8, units = "cm")
```

