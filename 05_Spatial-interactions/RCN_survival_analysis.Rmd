---
title: "R Notebook"
output: html_notebook
---


```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(survival)
library(survminer)
library(gridExtra)
library(grid)
library(forestploter)
library(ComplexHeatmap)
library(circlize)
```

#Output folder
```{r}
out.folder.name <- "D:/users/fperez/NKI_TMAs_AF/Analysis_results/03_RCN_2024_metaclusters/"
```


#Reading input
```{r}
#Reading file that matches clinical info with tcycif core ids
cycif2samples <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Clinical_intersection/All-slides_cycif2samples.txt",
                            sep="\t", header = TRUE)

#Reading clinical info
clinical.info <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Clinical_data/T-CycIF.update.csv",
                            sep=",", header = TRUE)

clin.tcycif <- merge(cycif2samples, clinical.info, by.x="patient", by.y="TnumberAVL", all.x = TRUE)

#Loading Molecular profiles by patient
M.profiles <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Tables/Molecular_profiles_patients_20231208.csv",
             sep=",", header = TRUE)

#Reading input cell proportion table by patient
core.cell.prop <- read.table(file="D:/users/fperez/NKI_TMAs_AF/Analysis_results/01_Cell-proportions_Heatmaps_Nov2023/Proportions_by_core.csv", sep=",", header = TRUE)

#Reading RNCs proportions by tcycif core
RCN.proportions.image <- read.table(file=paste0(out.folder.name, "RCN_by_image.csv"),  sep=",",header = TRUE)
RCN.proportions.image
```

##Re-naming the RCN accordint to the RNC group they belong
```{r}
#New names
new.vals <- c("RCN01", "RCN02", "RCN03","RCN04", "RCN05", "RCN06","RCN07", "RCN08", "RCN09","RCN10",
          "RCN11", "RCN12", "RCN13", "RCN14")

#Original names, with the order according to the groups
order <- c("RCN01", "RCN03", "RCN11", "RCN02", "RCN05", "RCN06", "RCN09", "RCN12", "RCN04", "RCN07",
               "RCN08", "RCN10", "RCN13", "RCN14")

names(new.vals) <- order
RCN.proportions.image$rcn_id <- new.vals[RCN.proportions.image$rcn_id]
```



#Identifying patients with in global, a high proportion of cancer cells per all samples
```{r}
cancer.prop.patient <- core.cell.prop %>%  group_by(patient) %>% 
                                mutate(Prop.cell = n/sum(n)) %>% filter(GlobalCellType == "Cancer") %>% 
                                summarise(Cancer.prop=sum(Prop.cell)) %>% 
                                dplyr::filter(Cancer.prop >= 0.05) %>% 
                                pull(patient)
```



#Merging M.profile info with tCycif core ID
```{r}
Mol.profiles.patients  <- merge(M.profiles, cycif2samples, by="patient", all.x=TRUE)
Mol.profiles.patients$imageid <- paste(Mol.profiles.patients$cycif.slide, Mol.profiles.patients$cycif.core.id, sep="_")
Mol.profiles.patients <- Mol.profiles.patients %>% select(patient,Molecular.profile2,therapy_sequence,imageid)
Mol.profiles.patients


#Selecting relevant columns from the clinical info
interesting.clin.columns <- c("TnumberAVL", "centre","refage","incyear","timelastfu","daystoprogression",
                              "finalstatus","progression","figo_stage")

clinical.info.sel <- clinical.info %>% select(interesting.clin.columns)

#Merging with molecular profile
M.profiles.clin <- merge(Mol.profiles.patients, clinical.info.sel, by.x="patient", by.y="TnumberAVL", all.x = TRUE)

#Re-naming therapy sequence as IDS and PDS
M.profiles.clin$therapy_sequence2 <- ifelse(grepl("NACT", M.profiles.clin$therapy_sequence), "IDS","PDS")
M.profiles.clin$therapy_sequence2[is.na(M.profiles.clin$therapy_sequence)] <- NA


#Converting survival info from days to months
M.profiles.clin$timelastfu <- M.profiles.clin$timelastfu/30.4
M.profiles.clin$daystoprogression <- M.profiles.clin$daystoprogression/30.4

#Structuring data
M.profiles.clin$figo_stage2 <- NA
M.profiles.clin$figo_stage2[M.profiles.clin$figo_stage == "FIGO II"] <- 2
M.profiles.clin$figo_stage2[M.profiles.clin$figo_stage == "FIGO III"] <- 3
M.profiles.clin$figo_stage2[M.profiles.clin$figo_stage == "FIGO IV"] <- 4

#Structuring Age
M.profiles.clin$refage2 <- NA
M.profiles.clin$refage2[M.profiles.clin$refage < 50] <- 0
M.profiles.clin$refage2[M.profiles.clin$refage >= 50 & M.profiles.clin$refage < 60] <- 1
M.profiles.clin$refage2[M.profiles.clin$refage >= 60 & M.profiles.clin$refage < 70] <- 2
M.profiles.clin$refage2[M.profiles.clin$refage >= 70 & M.profiles.clin$refage < 80] <- 3
M.profiles.clin$refage2[M.profiles.clin$refage >= 80] <- 4
```



#Merging RCN information with clinical.data and calculating proportion by patient and cutoff points for high abundance
```{r}
#Merging tcycif RCN proportion with patient info
RCN.proportions.image.patient <- merge(RCN.proportions.image, M.profiles.clin, by="imageid")[,c(1:5)]

patients.two.cores <- RCN.proportions.image.patient %>% group_by(patient) %>%
                                          summarise(N.cores = length(unique(imageid))) %>% 
                                          filter(N.cores >= 2) %>% pull(patient)


#Calculating the median proportion of RCN by patient (median value in their 4 cores)
#Selecting only patients with at least two cores
#Selecting only patients with more than 5% of cancer cells
RCN.proportions.patient <- RCN.proportions.image.patient %>% 
                                  filter(patient %in% patients.two.cores) %>%  
                                  #filter(patient %in% cancer.prop.patient) %>% 
                                  group_by(patient, rcn_id) %>%
                                  summarise(Med.prop=median(Proportion))

#Matrix of median proportions by RNC per patient
RCN.proportions.patient.m <- RCN.proportions.patient %>%
                              pivot_wider(names_from = rcn_id, values_from = Med.prop)

RCN.proportions.patient.m <- as.data.frame(RCN.proportions.patient.m)
row.names(RCN.proportions.patient.m) <- RCN.proportions.patient.m[,1]
RCN.proportions.patient.m[is.na(RCN.proportions.patient.m)] <- 0

#Merging median proportions with clinical info.
#Column 4 is imageid, not needed any more, now is only patient median proportions
RCN.proportions.patient.m.clin <- unique(merge(RCN.proportions.patient.m,
                                               unique(M.profiles.clin[,-4]), by="patient"))

RCN.proportions.patient.clin <- merge(RCN.proportions.patient, unique(M.profiles.clin[,-4]), by="patient")


cutpoints <- sapply(colnames(RCN.proportions.patient.m)[-1], function(x){
              var = x
              median.var <- median(RCN.proportions.patient.m[,var])
              return(median.var)
})
RCN.proportions.patient.clin
```


#Calculating correlation between cell RCNs
```{r}
library(corrplot)
library(Hmisc)
library(ggcorrplot)

#The correlation is calculated per median proportion of RCNs per tumor (patient)

vars.all <- c("RCN01","RCN02","RCN03","RCN04","RCN05","RCN06","RCN07",
                    "RCN08","RCN09","RCN10","RCN11","RCN12","RCN13","RCN14")

cols.fun= circlize::colorRamp2(c(0, -1, 1), c("white", "blue3","yellow3"))

dat <- RCN.proportions.patient.m %>% select(all_of(vars.all)) %>% as.matrix()


#Correlation and p value correlations
corr.dat <- cor(dat)
p.mat <- ggcorrplot::cor_pmat(dat)

#Witting Supplementary Table 4
write.table(corr.dat, file = paste0(out.folder.name, "Correlation_matrix_RCNs.csv"), sep=",")

#Lower and upper matrix p.values and p.value adjustment
#Done this independently because is a symmetrical matrix
p.vals.lower <- p.mat[lower.tri(p.mat)]
p.vals.upper <- p.mat[upper.tri(p.mat)]
p.mat[lower.tri(p.mat)] = p.adjust(p.vals.lower)
p.mat[upper.tri(p.mat)] = p.adjust(p.vals.upper)

#Witting Supplementary Table 5
write.table(p.mat, file = paste0(out.folder.name, "Correlation_matrix_RCNs_FDR.csv"), sep=",")


#Ingoring values for FDR values lower than 0.05
corr.dat[p.mat >= 0.05] <- 0

#For Supplementary Figure2a
hmap <- ComplexHeatmap::Heatmap(corr.dat, name="Pearson\ncorrelation", col = cols.fun, na_col="white",
                        column_names_rot = 60, rect_gp = gpar(col = "white", lwd = 1))

pdf(paste0(out.folder.name, "Heatmap_RCNs_correlations.pdf"), width=6, height=5)
draw(hmap)
dev.off()


```





#Performing Kapplan-Meir plots for the abundance of each RCN, according to therapy sequence
```{r}
output.folder = paste0(out.folder.name, "/survival/")
dir.create(paste0(output.folder))

suffix <- c("PDS","IDS")
list.class <- list(c("PDS"),
                   c("IDS"))

vars.all <- unique(RCN.proportions.patient.clin$rcn_id)


for (j in 1:length(suffix)){
  data.in <- RCN.proportions.patient.m.clin[RCN.proportions.patient.m.clin$therapy_sequence2 %in% list.class[[j]],]
  lastcol <- ncol(data.in)
  
  plots.OS <- lapply(vars.all, function(x){
  vars = x
  cut.off.value <- cutpoints[names(cutpoints) == vars]
  cat.var <- as.factor(ifelse(data.in[,vars] >  cut.off.value, "high","low"))
  data.in[,lastcol] <- cat.var
  colnames(data.in)[lastcol] <- "aux"
  fit <- survfit(Surv(timelastfu, finalstatus) ~ aux, data = data.in)
  logrank = surv_pvalue(fit, data.in)
  pval=logrank$pval.txt
  p <- ggsurvplot(fit, data = data.in, risk.table = TRUE, p.val=TRUE, conf.int = TRUE,
                  font.legend = c(18, "plain"), font.tickslab = c(16, "plain"),
                  font.x = c(18, "plain"), font.y = c(18, "plain"),
                  tables.y.text = FALSE,  break.time.by=20, xlim = c(0,80),
                  legend.labs=c(paste0(vars, "+"),paste0(vars, "-")),
                  palette = c("#ff5a36", "#4d4dff")) 
  p$plot <- p$plot + guides(colour = guide_legend(nrow = 2))
  p <- p + ylab("OS probability") + xlab("Time (months)")
  p$plot <- p$plot + theme(legend.key.width = unit(3, "line"), plot.margin = margin(t = 0,  r = 2, b = 0, l = 2, unit = "cm"), legend.key.height = unit(1.5, "line"))
  p$plot <- p$plot + ggplot2::annotate("text", x = 65, y = 0.85, label =pval, size = 5)
  p$table <- p$table + theme(plot.margin = margin(t = 0,  r = 2, b = 0, l = 2, unit = "cm"))
  plots <- list(plot=p$plot, table=p$table)
  return(plots)
  })
  fig.OS <- lapply(1:length(plots.OS) , function(x){plots.OS[[x]]$plot})
  tables.OS <- lapply(1:length(plots.OS) , function(x){plots.OS[[x]]$table})
  
  
  plots.PFI <- lapply(vars.all, function(x){
  vars = x
  cut.off.value <- cutpoints[names(cutpoints) == vars]
  cat.var <- as.factor(ifelse(data.in[,vars] >  cut.off.value, "high","low"))
  data.in[,lastcol] <- cat.var
  colnames(data.in)[lastcol] <- "aux"
  fit <- survfit(Surv(daystoprogression, progression) ~ aux, data = data.in)
  logrank = surv_pvalue(fit, data.in)
  pval=logrank$pval.txt
  p <- ggsurvplot(fit, data = data.in, risk.table = TRUE, p.val=TRUE, conf.int = TRUE,
                  font.legend = c(18, "plain"), font.tickslab = c(16, "plain"),
                  font.x = c(18, "plain"), font.y = c(18, "plain"),
                  tables.y.text = FALSE,  break.time.by=20, xlim = c(0,80),
                  legend.labs=c(paste0(vars, "+"),paste0(vars, "-")),
                  palette = c("#ff5a36", "#4d4dff")) 
  p$plot <- p$plot  +     guides(colour = guide_legend(nrow = 2))
  p <- p + ylab("PFI probability") + xlab("Time (months)")
  p$plot <- p$plot + theme(legend.key.width = unit(3, "line"), plot.margin = margin(t = 0,  r = 2, b = 0, l = 2, unit = "cm"), legend.key.height = unit(1.5, "line"))
  p$plot <- p$plot + ggplot2::annotate("text", x = 65, y = 0.85, label =pval, size = 5)
  p$table <- p$table + theme(plot.margin = margin(t = 0,  r = 2, b = 0, l = 2, unit = "cm"))
  plots <- list(plot=p$plot, table=p$table)
  return(plots)
  })
  fig.PFI <- lapply(1:length(plots.PFI) , function(x){plots.PFI[[x]]$plot})
  tables.PFI <- lapply(1:length(plots.PFI) , function(x){plots.PFI[[x]]$table})
  
  ggsave(file=paste0(output.folder,suffix[j], "_OS.svg"), arrangeGrob(grobs = fig.OS, ncol = 2),
         width = 23, height = 50, units = "cm")
  
  ggsave(file=paste0(output.folder,suffix[j], "_OS-table.svg"), arrangeGrob(grobs = tables.OS, ncol = 2),
         width = 23, height = 22, units = "cm")
  
  ggsave(file=paste0(output.folder,suffix[j],"_PFI.svg"), arrangeGrob(grobs = fig.PFI, ncol = 2),
         width = 23, height = 50, units = "cm")
  
  ggsave(file=paste0(output.folder,suffix[j],"_PFI-table.svg"), arrangeGrob(grobs = tables.PFI, ncol = 2),
         width = 23, height = 22, units = "cm")
}
```

#Function to calculate cox hazzard ratios
```{r}
#Indicate the variables for which is going to be calculated the cox model
Cox.regresion.variables2 <- function(data, variables, formula='Surv(timelastfu, finalstatus)~'){

   univ_formulas <- sapply(variables,
                           function(x) as.formula(paste(formula, x)))

   univ_models <- lapply( univ_formulas, function(x){coxph(x, data = data, method = "exact")})

   univ_results <- lapply(univ_models,
                          function(x){
                             x <- summary(x)
                             positive <- x$nevent
                             prop.positive <- paste0(round((x$nevent) * 100 /x$n,0),"%")
                             #p.value <- signif(x$wald["pvalue"], digits=2) #p.value for the model
                             wald.test <- signif(x$wald["test"], digits=2)
                             lastrow <- nrow(x$coef) #When using several covariables in the same regression, take the last one used
                             p.value <- signif(x$coef[lastrow, "Pr(>|z|)"], digits=2) #p.value for last covariable
                             beta <- signif(x$coef[lastrow, 1], digits=2);#coeficient beta
                             HR <- signif(x$coef[lastrow, 2], digits=2);#exp(beta)
                             HR.confint.lower <- signif(x$conf.int[lastrow,"lower .95"], 2)
                             HR.confint.upper <- signif(x$conf.int[lastrow,"upper .95"],2)
                             res <- c(HR, p.value, HR.confint.lower,HR.confint.upper)
                             names(res)<-c("HR", "p.value", "HR.confint.lower", "HR.confint.upper")
                             return(res)
                          })
   res <- t(as.data.frame(univ_results, check.names = FALSE))
   result <- as.data.frame(res)
   return(result)
}
```


#Calculating individual cox hazzard ratios per cell.type and including the Molecular profile in each
```{r}
output.folder = paste0(out.folder.name, "/survival/")
tm <- forest_theme(core=list(bg_params=list(fill = c("grey90", "#eaf8f5", "white"))))


formulas <- c('Surv(timelastfu, finalstatus)~ Molecular.profile2 + refage2  + figo_stage2 +',
              'Surv(daystoprogression, progression)~ Molecular.profile2 + refage2  + figo_stage2 +')

formula.suffix <- c('OS_mprofile_age_figo', 'PFS_mprofile_age_figo')

vars.all <- c("RCN01","RCN02","RCN03","RCN04","RCN05","RCN06","RCN07",
                    "RCN08","RCN09","RCN10","RCN11","RCN12","RCN13","RCN14")

#vars.all <- c("RCN01", "RCN03", "RCN11","RCN02","RCN05","RCN06","RCN09","RCN12",
#                "RCN04", "RCN07", "RCN08","RCN10","RCN13","RCN14")

#vars.sel <- c("RCN02","RCN03","RCN06","RCN09","RCN10","RCN11","RCN12")
therapies <- c("IDS","PDS")


for (index in 1:length(formulas)){
    #Calculating cox hazards for each therapy sequence samples
    cox.therpies <- lapply(therapies, function(x){
          dat <- RCN.proportions.patient.m.clin[(RCN.proportions.patient.m.clin$therapy_sequence2 %in% x),]
          t.rows <- which(RCN.proportions.patient.m.clin$therapy_sequence2 %in% x)
    
          
          #Stratifying all the patients in the cohort in 4 tiles using RCN proportions 
          for (j in vars.all){
            dat[,j] <- ntile(RCN.proportions.patient.m.clin[,j], 4)[t.rows]
          }
          #Calculating cox models
          Cox.rcn <- Cox.regresion.variables2(dat, vars.all, formula=formulas[index])
          Cox.rcn$Treatment <- x
          Cox.rcn$RCN <- rownames(Cox.rcn)
          Cox.rcn$p.value <- signif(p.adjust(Cox.rcn$p.value, method ="BH"),2)
          return(Cox.rcn)
      })
  
  
  #Reordering the cox results in an specific way necessary for the package forestplot
  spacer <- paste(rep(" ", 18), collapse = " ") #For the forest plot table
  cox.groups <- rbind(cox.therpies[[2]], cox.therpies[[1]])
  cox.groups <- cox.groups %>% filter(RCN %in% vars.all)
  df.forest <- NULL
  for (i in unique(cox.groups$RCN)){
        row.class <- data.frame(RCN =i, HR="", space=spacer, p.value=NA, HR.confint.lower=NA,
                                HR.confint.upper=NA, HR2=NA)
        set.df <- cox.groups[cox.groups$RCN %in% i,]
        set.df$space <- spacer
        set.df$HR2 <- set.df$HR
        set.df.reordered <- set.df %>% select(Treatment, HR, space, p.value,
                                              HR.confint.lower, HR.confint.upper, HR2)
        colnames(set.df.reordered) <- colnames(row.class)
        row.celltype <- rbind(row.class, set.df.reordered)
        df.forest <- rbind(df.forest, row.celltype)
  }
  colnames(df.forest)[3] <- ""
  colnames(df.forest)[2] <- "HR"
  
  #Adding * to pvalues lower than 0.05
  low.pvals <- which(df.forest$p.value < 0.05)
  tiny.pvals <- which(df.forest$p.value < 0.001)
  df.forest$p.value[low.pvals] <- paste0(df.forest$p.value[low.pvals],"*")
  df.forest$p.value[tiny.pvals] <- "<0.001**"
  df.forest$p.value[which(is.na(df.forest$p.value))] = ""
  colnames(df.forest)[4] <- "FDR"
  
  #indent the subgroup if there is a number in the HR2 column
  df.forest$RCN <- ifelse(is.na(df.forest$HR2), 
                                df.forest$RCN,
                                #unlist(sapply(df.forest$Cell.type, function(x){cat("\t",x)})))
                                paste0("", df.forest$RCN))
  
  
  p <- forest(df.forest[,c(1:4)],
              est = df.forest$HR2,
              lower = df.forest$HR.confint.lower, 
              upper = df.forest$HR.confint.upper,
              sizes = 0.5,
              ci_column = 3,
              ref_line = 1,
              xlim = c(0, 2.5),
              arrow_lab = c("Lower risk", "Higher risk"),
              ticks_at = c(0.5, 1, 1.5, 2.0,2.5),
              theme = tm)
  print(p)
  
  ggplot2::ggsave(filename = paste0(output.folder, "Forest_plot_", formula.suffix[index], ".svg"), plot = p,
                   width = 15, height = 28, units = "cm", device = svglite::svglite)
  
  ggplot2::ggsave(filename = paste0(output.folder, "Forest_plot_", formula.suffix[index], ".png"), plot = p,
                   width = 15, height = 28, units = "cm")
}
```




#Making multi-variable cox model with the RCNs that are sig. associated with OS
```{r}
therapies <- c("PDS","IDS")

formulas.cox <- c('Surv(timelastfu, finalstatus) ~ RCN03.strat + RCN09.strat + RCN10.strat + Age + Stage + Molecular.profile + Therapy.sequence',
            'Surv(daystoprogression, progression)~ RCN03.strat + RCN09.strat + RCN10.strat + Age + Stage + Molecular.profile + Therapy.sequence')

formulas.names <- c("OS","PFI")
formulas.labs <- c("OS probability","PFI probability")
df <- RCN.proportions.patient.m.clin %>% filter(!is.na(therapy_sequence2))


df[df$Molecular.profile2 == "BRCAmut/met","Molecular.profile2"] <- "BRCAloss"
colnames(df)[which(colnames(df)=="refage2")] <- "Age"
colnames(df)[which(colnames(df)=="figo_stage2")] <- "Stage"
colnames(df)[which(colnames(df)=="Molecular.profile2")] <- "Molecular.profile"
colnames(df)[which(colnames(df)=="therapy_sequence2")] <- "Therapy.sequence"


df$Molecular.profile <- factor(df$Molecular.profile, levels=c("HRP","BRCAloss","HRD","CCNE1amp"))


for (i in 1:length(formulas.cox)){
    #Stratification in ntiles for cox models
    df$RCN03.strat <- ntile(df$RCN03,4)
    df$RCN09.strat <- ntile(df$RCN09,4)
    df$RCN10.strat <- ntile(df$RCN10,4)
    
    #Cox model 
    cox.model <- coxph(as.formula(formulas.cox[i]), data=df)
    p1 <- ggforest(cox.model, data = df, main=paste0(formulas.labs[i]," ALL"))
    print(p1)
    ggsave(p1, file=paste0(output.folder, "Cox_RCNs_ALL_", formulas.names[i],".svg"),
          width = 14, height = 12, units = "cm")
     ggsave(p1, file=paste0(output.folder, "Cox_RCNs_ALL_", formulas.names[i],".png"),
      width = 14, height = 12, units = "cm")
}

formulas.cox <- c('Surv(timelastfu, finalstatus) ~ RCN03.strat + RCN09.strat + RCN10.strat + Age + Stage + Molecular.profile',
            'Surv(daystoprogression, progression)~ RCN03.strat + RCN09.strat + RCN10.strat + Age + Stage + Molecular.profile')


for (t in therapies){
    df.set <- df %>% filter(Therapy.sequence == {t})
    for (i in 1:length(formulas.cox)){
     #Cox model 
     cox.model <- coxph(as.formula(formulas.cox[i]), data=df.set)
     p1 <- ggforest(cox.model, data = df.set, main=paste0(formulas.labs[i]," ", t))
     print(p1)
     ggsave(p1, file=paste0(output.folder, "Cox_RCNs_",t, "_", formulas.names[i],".png"),
            width = 14, height = 7, units = "cm")
      ggsave(p1, file=paste0(output.folder, "Cox_RCNs_",t, "_", formulas.names[i],".svg"),
            width = 14, height = 7, units = "cm")
    }
}

```


###Next lines to calculate median the proportion of celltypes by Molecular profiles
```{r}
order.vars  <- c("RCN01","RCN02","RCN03","RCN04","RCN05","RCN06","RCN07",
                   "RCN08","RCN09","RCN10","RCN11","RCN12","RCN13","RCN14")

melt.patient.cell.prop.clin =  RCN.proportions.patient.clin

#Re-organizing data
melt.patient.cell.prop.clin$Molecular.profile2[melt.patient.cell.prop.clin$Molecular.profile2 == "BRCAmut/met"] <- "BRCAloss"

#Ignoring Molecular.profile "Others" from heatmaps
melt.patient.cell.prop.clin <- melt.patient.cell.prop.clin[melt.patient.cell.prop.clin$Molecular.profile2 != "Other",]
melt.patient.cell.prop.clin$Molecular.profile2 <- factor(melt.patient.cell.prop.clin$Molecular.profile2,
                                                            levels=c("BRCAloss", "HRD", "HRP","CCNE1amp"))
krustal.df <- NULL
for (t in c("IDS","PDS")){
    dat.sel <- melt.patient.cell.prop.clin[melt.patient.cell.prop.clin$therapy_sequence2 == t,]
    #Calculating p.values
    kruskal.pvals <- lapply(order.vars, function(x){
                  df <- dat.sel[which(dat.sel$rcn_id == x),]
                  k.res <- kruskal.test(Med.prop ~ Molecular.profile2, data=df)
                  res <- data.frame(RCN=x, pval=k.res$p.value, y.val = 0.8,
                                    therapy_sequence=t)
                  return(res)
    })
    for (i in 1:length(kruskal.pvals)){krustal.df <- rbind(krustal.df, kruskal.pvals[[i]])}
}
krustal.df <- krustal.df %>% group_by(therapy_sequence) %>% mutate(FDR=p.adjust(pval, method = "BH"))

#Calculating the median proportion by molecular profiles for each therapy sequence
med.prop.profile <- melt.patient.cell.prop.clin %>%  group_by(Molecular.profile2, therapy_sequence2, rcn_id) %>%
                    summarise(Prop=median(Med.prop))

#Changing  median proportions to matrix 
mt.prop.profile <- med.prop.profile %>% pivot_wider(names_from = rcn_id, values_from = Prop)
mt.prop.profile <- as.data.frame(mt.prop.profile)
mt.prop.profile[is.na(mt.prop.profile)] <- 0
colnames(mt.prop.profile)[colnames(mt.prop.profile) == "therapy_sequence2"] = "therapy_sequence"


#Scaling proportions using z-score
#mt.prop.scaled <- as.data.frame(scale(mt.prop.profile[,c(-1,-2)]))
mt.prop.scaled <- mt.prop.profile
mt.prop.scaled$Molecular.profile2 <- mt.prop.profile$Molecular.profile2
mt.prop.scaled$therapy_sequence <- mt.prop.profile$therapy_sequence

#Preparing data for creating complex heatmap
M.profile.order <- mt.prop.scaled$Molecular.profile2 
therapy.order <- mt.prop.scaled$therapy_sequence 
mt.prop.scaled <- mt.prop.scaled %>%
                          select(all_of(order.vars)) %>%
                          as.matrix()


colours <- list(Therapy=c("IDS"="black", "PDS"="grey90"),
                 M.profile=c("BRCAloss" = "#FF0000", "HRD" = "#AB1717", "CCNE1amp"="darkblue", "HRP"="#1E90FF",
                             "Other"="grey60"))

ha = rowAnnotation(Therapy=therapy.order, M.profile=M.profile.order, col=colours)
col_fun = colorRamp2(c(0, max(mt.prop.scaled[,-c(1,2)])), c("white", "#b30000"))


hmap <- Heatmap(mt.prop.scaled, right_annotation = ha, cluster_columns = FALSE, cluster_rows = FALSE,
        name="Median proportion \n (Z-score)",  col = col_fun)
svg(paste0(out.folder.name, "Heatmap_Mprofile_RCNs_prop.svg"), width=8, height=5)
draw(hmap)
dev.off()



#Scaling by therapy sequence
# mt.prop.scaled <- mt.prop.profile %>% group_by(therapy_sequence) %>% 
#                    mutate(across(where(is.numeric), ~ as.numeric(scale(.)))) %>%
#                    as.data.frame()

mt.prop.scaled <- mt.prop.profile

for (t in c("PDS","IDS")){
  #Preparing data for creating complex heatmap
  M.profile.order <- mt.prop.scaled %>% filter(therapy_sequence == {{t}}) %>%
                                    pull(Molecular.profile2)
  mt.prop.scaled.sel <- mt.prop.scaled %>% filter(therapy_sequence == {{t}}) %>%
                                    select(all_of(order.vars)) %>%
                                    as.matrix()
  mt.prop.scaled.sel <- t(mt.prop.scaled.sel)
  colnames(mt.prop.scaled.sel) <- as.character(M.profile.order)
  
  pvalue <- krustal.df %>% filter(therapy_sequence == t) %>% pull(pval)
  is_sig = pvalue < 0.05
  pch = rep("P<0.05", 10)
  pch[!is_sig] = NA
  pvalue_col_fun = colorRamp2(c(1, 0.05, 0.001), c("blue", "white", "red"))
  
  ha = rowAnnotation(Significance=pch, col=list(Significance=c("P<0.05"="cyan4")),
                     na_col="grey95",  width = unit(10, "cm"))

  col_fun = colorRamp2(c(0, 0.35), c("white", "#9a0000"))

  
  hmap <- Heatmap(mt.prop.scaled.sel, cluster_columns = FALSE, cluster_rows = FALSE, row_names_side = "left",
          name="Median\nproportion", column_names_rot = 45, rect_gp = gpar(col = "white", lwd = 0.5),
          column_title =t, col = col_fun, right_annotation = ha, na_col="white")
  
  #see how we define the legend for pvalue
  lgd_pvalue = Legend(title = "p-value", col_fun = pvalue_col_fun, at = c(1, 0.05, 0.01, 0.001), 
  labels = c("1", "0.05", "0.01", "0.001"))
  # and one for the significant p-values
  lgd_sig = Legend(pch = "*", type = "points", labels = "< 0.05")
  
  pdf(paste0(out.folder.name, "Heatmap_Mprofile_ImmuneStromalCancer_prop_", t, ".pdf"), width=3.3, height=5)
  draw(hmap)
  dev.off()
}
```

#Declaring functions
```{r}
#Function to calculate Wilcoxon.text for each Molecular.profile2 vs the rest of the profiles. It returns a dataframe.
#Y.val is used for plotting of the significant p.values using ggplot2
p.vals.markers2 <- function(data, Profile.test="HRD", y.val=25, alt.hypothesis="greater"){
       test.dat <- data$Proportion[data$Molecular.profile2 == Profile.test]
       p.vals <- sapply(unique(data$Molecular.profile2), function(x){
                mol.dat <- data$Proportion[data$Molecular.profile2 == x]
                wtest <- wilcox.test(test.dat, mol.dat)
                wtest$p.value
       })
      #Organizing p-values in data.frame for plotting using geom_text
      p.vals.dataframe <- data.frame(pval=p.vals,
                           Molecular.profile2=unique(data$Molecular.profile2),
                           Y.val=y.val)
      return(p.vals.dataframe)
}

```



#Making violin plots with p.values compared to BRCAloss
```{r}
# order.vars <- c("RCN01", "RCN03", "RCN11","RCN02","RCN05","RCN06","RCN09","RCN12",
#                 "RCN04", "RCN07", "RCN08","RCN10","RCN13","RCN14")


list.vars <- list(vars1=c("RCN09"),
     vars2=c("RCN10"))

y.text <- c(0.50, 0.21)
y.lim <- c(0.50, 0.25) 
heights <- c(11, 11)

for (index.var in 1:length(list.vars)){

order.vars <- list.vars[[index.var]]

#Selecting data for plotting
dat <- RCN.proportions.patient.m.clin
dat$Molecular.profile2[dat$Molecular.profile2 == "BRCAmut/met"] <- "BRCAloss"
dat <- dat %>% filter(Molecular.profile2 != "Other")
dat$Molecular.profile2 <- factor(dat$Molecular.profile2, levels=c("BRCAloss", "HRD", "HRP","CCNE1amp"))
dat <- dat %>% select(all_of(c("patient", order.vars, "Molecular.profile2", "therapy_sequence2")))


for (t in c("PDS","IDS")){
  dat.t <- dat[dat$therapy_sequence2 == t,]
  columns.extra <- c("patient","Molecular.profile2","therapy_sequence2")
  
  #Calculating Wilcoxon test, for proportions of cells per molecular profile compared to BRCAloss
  wilxcox.df <- NULL
  wilcox.pvals <-   lapply(order.vars, function(x){
              dat.sel <- dat.t[,c(columns.extra)]
              dat.sel$Proportion <- dat.t[,x]
              res <- p.vals.markers2(dat.sel, Profile.test="HRD", y.val = y.text[index.var])
              res$GlobalCelltype <- x
              return(res)
  })
  for (i in 1:length(wilcox.pvals)){wilxcox.df <- rbind(wilxcox.df, wilcox.pvals[[i]])}
  wilxcox.df$FDR <- p.adjust(wilxcox.df$pval, method ="BH") 
  wilxcox.df$Molecular.profile2 <- factor(wilxcox.df$Molecular.profile2, levels=c("BRCAloss", "HRD", "HRP","CCNE1amp"))
  
  #Selecting data for plotting
  df.selected <- RCN.proportions.patient.clin %>% filter(rcn_id %in% order.vars,
                                                        therapy_sequence2 == t,
                                                        Molecular.profile2 != "Other")
  
  df.selected$rcn_id <- factor(df.selected$rcn_id, levels=order.vars)
  df.selected$Molecular.profile2[df.selected$Molecular.profile2 == "BRCAmut/met"] <- "BRCAloss"
  df.selected$Molecular.profile2 <- factor(df.selected$Molecular.profile2,
                                           levels=c("BRCAloss", "HRD", "HRP","CCNE1amp"))

  
  p <- ggplot(df.selected, aes(x=Molecular.profile2,y=Med.prop)) + 
        geom_point(position= position_jitter(width= .3, height = 0), size= 1.2, alpha = 0.6) +
        geom_violin(fill="NA") + geom_boxplot(fill=NA, width=0.1, outlier.shape = NA) +
        stat_summary(geom = "errorbar", fun.y = "median", aes(ymax = ..y.., ymin = ..y..), width=0.7, size = 0.8) +
        theme(strip.placement = "outside",strip.background = element_blank(),
                 axis.title.y = element_text(size=rel(1.3)),
                 axis.title.x = element_blank(),
                 axis.text.y= element_text(size=rel(1.3)),
                 axis.text.x= element_text(size=rel(1.4), angle = 45, vjust = 1.05, hjust=1, colour = "black"),
                 legend.text= element_text(size=rel(1.1)),
                 strip.text.x = element_text(size=rel(1.2)),
                 legend.title=element_blank(),
                 panel.spacing = unit(1, "lines"),
                 plot.title = element_text(size=rel(1.6)),
                 strip.text = element_text(size=rel(0.6)),
                 panel.border = element_rect(linetype = "solid", fill = NA),
                 panel.background = element_rect(fill = "white"),
                 panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "lightgrey"),
                 panel.grid.minor = element_blank(),
                 panel.grid.major.x = element_blank(),
                 panel.grid.minor.x = element_blank()) + 
         geom_text(data = wilxcox.df[wilxcox.df$pval < 0.05,], aes(x=Molecular.profile2, y=Y.val),
                label="*", size=8) +  ylim(-0.03,y.lim[index.var]) +
         stat_n_text(size=3) +
                ggtitle(t) #+ facet_wrap(~forcats::fct_relevel(rcn_id, order.vars)) 
                
  print(p)
  ggsave(p, file=paste0(out.folder.name, "Boxplots_cell_proportions_comparisons_", t, index.var, ".svg"),
         height = heights[index.var], width = 6, units = "cm")
}
}
```








```{r}

```







#Paired comparison to check if the abundance of RNC09 is higher than RCN10 for each molecular profile
```{r}
therapies <- list("PDS","IDS")

RCNs.interest <- c("RCN09","RCN10")

y.text <- c(0.50, 0.21)
y.lim <- c(0.50, 0.25) 
heights <- c(11, 11)

for (t in therapies){
#Selecting data for comparison
dat <- RCN.proportions.patient.m.clin %>%  filter(therapy_sequence2 == {t}) 
dat$Molecular.profile2[dat$Molecular.profile2 == "BRCAmut/met"] <- "BRCAloss"
dat <- dat %>% filter(Molecular.profile2 != "Other")
dat$Molecular.profile2 <- factor(dat$Molecular.profile2, levels=c("BRCAloss", "HRD", "HRP","CCNE1amp"))
dat <- dat %>% select(all_of(c("patient", RCNs.interest, "Molecular.profile2", "therapy_sequence2")))


df.pvals <- NULL
pvals.comp <- lapply(unique(dat$Molecular.profile2), function(x) {
    dat.t <- dat[dat$Molecular.profile2 == x,]
    u.test <- wilcox.test(dat.t$RCN10, dat.t$RCN09)
    df.iter <- data.frame(pval=u.test$p.value, Molecular.profile2=as.character(x), Y.val=0.85)
    return(df.iter)
})
for (i in 1:length(pvals.comp)){df.pvals <- rbind(df.pvals, pvals.comp[[i]])}
print(df.pvals)

#Organizing data for plotting
melt.dat <- melt(dat)
colnames(melt.dat)[colnames(melt.dat) == "variable"] <- "RCN"
colnames(melt.dat)[colnames(melt.dat) == "value"] <- "Proportion"

  p <- ggplot(melt.dat, aes(x=Molecular.profile2,y=Proportion, fill=RCN)) +
        geom_violin(aes(fill=RCN)) + 
        geom_boxplot(aes(fill=RCN, x=Molecular.profile2, y=Proportion), width=0.15,
                     outlier.shape = NA, position = position_dodge(0.9)) +
        stat_summary(geom = "errorbar", fun.y = "median",
                     aes(ymax = ..y.., ymin = ..y.., fill=RCN, x=Molecular.profile2), width=0.5, size = 0.8,
                     position = position_dodge(0.9)) +
        theme(strip.placement = "outside",strip.background = element_blank(),
                 axis.title.y = element_text(size=rel(1.3)),
                 axis.title.x = element_blank(),
                 axis.text.y= element_text(size=rel(1.3)),
                 axis.text.x= element_text(size=rel(1.4), angle = 45, vjust = 1.05, hjust=1, colour = "black"),
                 legend.text= element_text(size=rel(1.1)),
                 strip.text.x = element_text(size=rel(1.2)),
                 legend.title=element_blank(),
                 panel.spacing = unit(1, "lines"),
                 plot.title = element_text(size=rel(1.6)),
                 strip.text = element_text(size=rel(0.6)),
                 panel.border = element_rect(linetype = "solid", fill = NA),
                 panel.background = element_rect(fill = "white"),
                 panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "lightgrey"),
                 panel.grid.minor = element_blank(),
                 panel.grid.major.x = element_blank(),
                 panel.grid.minor.x = element_blank()) + 
          scale_fill_manual(values = c("grey95","grey40")) + ylim(0,0.4) +
          ggtitle(t) #+ facet_wrap(~forcats::fct_relevel(rcn_id, order.vars)) 
                
  print(p)
  ggsave(p, file=paste0(out.folder.name, "Boxplots_cell_RCN09_RCN10_comparison_", t, ".svg"),
         height = 12, width = 12, units = "cm")
}


```




```{r}
types <- c(".","NACT")
suffixes <- c("ALL","NACT","PDS")
output.folder <- "D:/users/fperez/NKI_TMAs_AF/Analysis_results/03_RCN/"

for (i in 1:3){
print(suffixes[i])
RCN.sel <- RCN.proportions.patient.clin[grepl(types[i],                                      
                                               RCN.proportions.patient.clin$therapy_sequence),]

if (i == 3){
  RCN.sel <- RCN.proportions.patient.clin[!grepl("NACT",RCN.proportions.patient.clin$therapy_sequence),]
}


#Plot for RCNs with higher abundace
#Statistics of difference in abundance of RNC4 vs RNC6 by Molecular profiles
p.vals.RCN4vsRCN6<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$Molecular.profile2 %in% x,]
  prop.rcn4 <- mol.dat$Proportion[mol.dat$rcn_id == "RCN04c"]
  prop.rcn6 <- mol.dat$Proportion[mol.dat$rcn_id == "RCN06c"]
  wtest <- wilcox.test(prop.rcn4, prop.rcn6)
  wtest$p.value
})
#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN4vsRCN6,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=28,
                     rcn_id="RCN04c")

rcn_set1 <- c("RCN04c","RCN06c")
p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=rcn_id)) +
  geom_boxplot(outlier.shape = NA) + theme_bw() + xlab("Molecular profile") +
  theme(legend.title = element_blank(), axis.text.x=element_text(size=rel(1.1)),
        axis.title.x = element_text(size=rel(1.1)), axis.title.y = element_text(size=rel(1.1)),
        axis.text.y=element_text(size=rel(1.1))) +
  scale_fill_manual(values = c("grey85", "grey30")) + ylim(0,32) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8)
ggsave(p, filename = paste0(output.folder, "/Barplot_RNC6vsRCN4_", suffixes[i],".png"), 
       width = 12, height = 10, units = "cm")


#For RCN06c
rcn_set1 <- c("RCN06c")
print(rcn_set1)
#Statistics of difference in abundance of RNC6 in BRCAmut samples vs other Molecular profiles
p.vals.RCN6vsBRCA<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$rcn_id %in% rcn_set1,]
  prop.BRCAmut <- mol.dat$Proportion[mol.dat$Molecular.profile2 == "BRCAmut/met"]
  prop.x <- mol.dat$Proportion[mol.dat$Molecular.profile2 == x]
  wtest <- wilcox.test(prop.BRCAmut, prop.x)
  wtest$p.value
})
#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN6vsBRCA,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=18,
                     Molecular.profile2=unique(RCN.sel$Molecular.profile2),
                     rcn_id=rcn_set1)

p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=Molecular.profile2)) +
  geom_boxplot(outlier.shape = NA) + theme_bw() + xlab("Molecular profile") +
  theme(axis.text.x=element_blank(), axis.title.x = element_text(size=rel(1.1)),
        axis.title.y = element_text(size=rel(1.1)), axis.text.y=element_text(size=rel(1.1))) + ylim(0,30) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8) +
  annotate("text", x=2.5, y=30, label="P-values calculated againts BRCAmut", fontface="italic", size = 2) +
  ggtitle(rcn_set1) + labs(fill = "Molecular profile")
ggsave(p, filename = paste0(output.folder, "Barplot_RNC06vsBRCAmut_", suffixes[i], ".png"), 
       width = 10, height = 10,  units = "cm")


#For RCN05c
rcn_set1 <- c("RCN05c")
print(rcn_set1)
#Statistics of difference in abundance of RCN05c in BRCAmut samples vs other Molecular profiles
p.vals.RCN6vsBRCA<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$rcn_id %in% rcn_set1,]
  prop.BRCAmut <- mol.dat$Proportion[mol.dat$Molecular.profile2 == "BRCAmut/met"]
  prop.x <- mol.dat$Proportion[mol.dat$Molecular.profile2 == x]
  wtest <- wilcox.test(prop.BRCAmut, prop.x)
  wtest$p.value
})
#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN6vsBRCA,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=8,
                     Molecular.profile2=unique(RCN.sel$Molecular.profile2),
                     rcn_id=rcn_set1)

p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=Molecular.profile2)) +
  geom_boxplot() + theme_bw() + xlab("Molecular profile") +
  theme(axis.text.x=element_blank(), axis.title.x = element_text(size=rel(1.1)),
        axis.title.y = element_text(size=rel(1.1)), axis.text.y=element_text(size=rel(1.1))) + ylim(0,10) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8) +
  annotate("text", x=2.5, y=10, label="P-values calculated againts BRCAmut", fontface="italic", size = 2) +
  ggtitle(rcn_set1) + labs(fill = "Molecular profile")
ggsave(p, filename = paste0(output.folder,"/Barplot_RNC05vsBRCAmut_", suffixes[i] ,".png"), 
       width = 10, height = 10,  units = "cm")



#For RCN11c
rcn_set1 <- c("RCN11c")
print(rcn_set1)
#Statistics of difference in abundance of RCN05c in BRCAmut samples vs other Molecular profiles
p.vals.RCN6vsBRCA<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$rcn_id %in% rcn_set1,]
  prop.BRCAmut <- mol.dat$Proportion[mol.dat$Molecular.profile2 == "BRCAmut/met"]
  prop.x <- mol.dat$Proportion[mol.dat$Molecular.profile2 == x]
  wtest <- wilcox.test(prop.BRCAmut, prop.x)
  wtest$p.value
})
#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN6vsBRCA,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=6,
                     Molecular.profile2=unique(RCN.sel$Molecular.profile2),
                     rcn_id=rcn_set1)

p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=Molecular.profile2)) +
  geom_boxplot() + theme_bw() + xlab("Molecular profile") +
  theme(axis.text.x=element_blank(), axis.title.x = element_text(size=rel(1.1)),
        axis.title.y = element_text(size=rel(1.1)), axis.text.y=element_text(size=rel(1.1))) + ylim(0,8) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8) +
  annotate("text", x=2.5, y=8, label="P-values calculated againts BRCAmut", fontface="italic", size = 2) +
  ggtitle(rcn_set1) + labs(fill = "Molecular profile")
ggsave(p, filename = paste0(output.folder,"/Barplot_RNC11vsBRCAmut_", suffixes[i],".png"), 
       width = 10, height = 10,  units = "cm")


#For RCN12c
rcn_set1 <- "RCN12c"
print(rcn_set1)
#Statistics of difference in abundance of RCN05c in BRCAmut samples vs other Molecular profiles
p.vals.RCN6vsBRCA<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$rcn_id %in% rcn_set1,]
  prop.BRCAmut <- mol.dat$Proportion[mol.dat$Molecular.profile2 == "CCNE1amp"]
  prop.x <- mol.dat$Proportion[mol.dat$Molecular.profile2 == x]
  wtest <- wilcox.test(prop.BRCAmut, prop.x)
  wtest$p.value
})

#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN6vsBRCA,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=6,
                     Molecular.profile2=unique(RCN.sel$Molecular.profile2),
                     rcn_id=rcn_set1)

p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=Molecular.profile2)) +
  geom_boxplot() + theme_bw() + xlab("Molecular profile") +
  theme(axis.text.x=element_blank(), axis.title.x = element_text(size=rel(1.1)),
        axis.title.y = element_text(size=rel(1.1)), axis.text.y=element_text(size=rel(1.1))) + ylim(0,3) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8) +
  annotate("text", x=2.5, y=3, label="P-values calculated againts CCNE1", fontface="italic", size = 2) +
  ggtitle(rcn_set1) + labs(fill = "Molecular profile")
ggsave(p, filename = paste0(output.folder, "/Barplot_RNC12vsCCNE1_" , suffixes[i], ".png"), 
       width = 10, height = 10,  units = "cm")



#For RCN02c, considering HRP
rcn_set1 <- "RCN02c"
print(rcn_set1)
#Statistics of difference in abundance of RCN05c in BRCAmut samples vs other Molecular profiles
p.vals.RCN6vsBRCA<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$rcn_id %in% rcn_set1,]
  prop.BRCAmut <- mol.dat$Proportion[mol.dat$Molecular.profile2 == "HRP"]
  prop.x <- mol.dat$Proportion[mol.dat$Molecular.profile2 == x]
  wtest <- wilcox.test(prop.BRCAmut, prop.x, alternative="greater")
  wtest$p.value
})

#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN6vsBRCA,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=100,
                     Molecular.profile2=unique(RCN.sel$Molecular.profile2),
                     rcn_id=rcn_set1)

p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=Molecular.profile2)) +
  geom_violin() + geom_boxplot(fill=NA, width=0.3) + theme_bw() + xlab("Molecular profile") +
  theme(axis.text.x=element_blank(), axis.title.x = element_text(size=rel(1.1)),
        axis.title.y = element_text(size=rel(1.1)), axis.text.y=element_text(size=rel(1.1))) + ylim(0,108) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8) +
  annotate("text", x=2.5, y=108, label="P-values calculated againts HRP", fontface="italic", size = 2) +
  ggtitle(rcn_set1) + labs(fill = "Molecular profile")
ggsave(p, filename = paste0(output.folder, "/Barplot_RNC02vsHRP_", suffixes[i],".png"), 
       width = 10, height = 10,  units = "cm")


#For RCN02c, considering HRP
rcn_set1 <- "RCN04c"
print(rcn_set1)
#Statistics of difference in abundance of RCN05c in BRCAmut samples vs other Molecular profiles
p.vals.RCN6vsBRCA<- sapply(unique(RCN.sel$Molecular.profile2), function(x){
  mol.dat <- RCN.sel[RCN.sel$rcn_id %in% rcn_set1,]
  prop.BRCAmut <- mol.dat$Proportion[mol.dat$Molecular.profile2 == "HRP"]
  prop.x <- mol.dat$Proportion[mol.dat$Molecular.profile2 == x]
  wtest <- wilcox.test(prop.BRCAmut, prop.x, alternative="greater")
  wtest$p.value
})

#Organizing p-values in data.frame for plotting using geom_text
p.vals.dataframe <- data.frame(pval=p.vals.RCN6vsBRCA,
                     Molecular.profile=unique(RCN.sel$Molecular.profile2),
                     y.val=40,
                     Molecular.profile2=unique(RCN.sel$Molecular.profile2),
                     rcn_id=rcn_set1)

p <- ggplot(RCN.sel[RCN.sel$rcn_id %in% rcn_set1,],
       aes(x=Molecular.profile2,y=Proportion, fill=Molecular.profile2)) +
  geom_violin() + geom_boxplot(fill=NA, width=0.3) + theme_bw() + xlab("Molecular profile") +
  theme(axis.text.x=element_blank(), axis.title.x = element_text(size=rel(1.1)),
        axis.title.y = element_text(size=rel(1.1)), axis.text.y=element_text(size=rel(1.1))) + ylim(0,40) +
  geom_text(data = p.vals.dataframe[p.vals.dataframe$pval < 0.05,], aes(x=Molecular.profile, y=y.val),
            label="*", size=8) +
  annotate("text", x=2.5, y=108, label="P-values calculated againts HRP", fontface="italic", size = 2) +
  ggtitle(rcn_set1) + labs(fill = "Molecular profile")
ggsave(p, filename = paste0(output.folder,"/Barplot_RNC04vsHRP_", suffixes[i], ".png"), 
       width = 10, height = 10,  units = "cm")
}
```